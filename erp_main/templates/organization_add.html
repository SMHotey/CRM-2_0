{% extends 'base.html' %}
{% block content %}

<div class="organization-create-container">
    <div class="organization-create-header">
        <h1 id="form-title" class="organization-create-title">–î–æ–±–∞–≤–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</h1>
        <p id="form-subtitle" class="organization-create-subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</p>
    </div>

    <form method="post" id="organization-form" class="organization-form" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-error" role="alert">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div class="alert-content">
                    <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:</strong>
                    <ul class="alert-list">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endif %}

        <!-- –¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">–¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h3>
            </div>
            <div class="type-selector">
                <label class="type-option">
                    <input type="radio" name="type" value="organization" checked onchange="toggleFields()">
                    <div class="type-card">
                        <div class="type-icon">üè¢</div>
                        <div class="type-content">
                            <h4>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</h4>
                        </div>
                        <div class="type-check"></div>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="type" value="individual" onchange="toggleFields()">
                    <div class="type-card">
                        <div class="type-icon">üë§</div>
                        <div class="type-content">
                            <h4>–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</h4>
                        </div>
                        <div class="type-check"></div>
                    </div>
                </label>
            </div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ -->
        <div id="organization-fields" class="form-section">
            <div class="section-header">
                <h3 class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
            </div>
            <div class="form-grid">
                <div class="form-field-group {% if form.inn.errors %}form-field-error{% endif %}">
                    <label for="{{ form.inn.id_for_label }}" class="form-label">
                        {{ form.inn.label }}
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        {{ form.inn }}
                        {% if form.inn.help_text %}
                            <div class="help-text">{{ form.inn.help_text }}</div>
                        {% endif %}
                    </div>
                    {% for error in form.inn.errors %}
                        <div class="field-error-message">
                            <span class="error-icon">‚ùå</span>
                            {{ error }}
                        </div>
                    {% endfor %}
                </div>

                <div class="form-field-group {% if form.name.errors %}form-field-error{% endif %}">
                    <label for="{{ form.name.id_for_label }}" class="form-label">
                        {{ form.name.label }}
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        {{ form.name }}
                        {% if form.name.help_text %}
                            <div class="help-text">{{ form.name.help_text }}</div>
                        {% endif %}
                    </div>
                    {% for error in form.name.errors %}
                        <div class="field-error-message">
                            <span class="error-icon">‚ùå</span>
                            {{ error }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="section-actions">
                <button type="button" class="btn btn-outline" onclick="toggleAdditionalFields()" id="additional-fields-btn">
                    <span class="btn-icon">üìã</span>
                    –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    <span class="btn-arrow">‚ñº</span>
                </button>
            </div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ -->
        <div id="individual-fields" style="display:none;" class="form-section">
            <div class="section-header">
                <h3 class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –ª–∏—Ü–µ</h3>
            </div>
            <div class="form-grid">
                <div class="form-field-group {% if form.name_fl.errors %}form-field-error{% endif %}">
                    <label for="{{ form.name_fl.id_for_label }}" class="form-label">
                        {{ form.name_fl.label }}
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        {{ form.name_fl }}
                        {% if form.name_fl.help_text %}
                            <div class="help-text">{{ form.name_fl.help_text }}</div>
                        {% endif %}
                    </div>
                    {% for error in form.name_fl.errors %}
                        <div class="field-error-message">
                            <span class="error-icon">‚ùå</span>
                            {{ error }}
                        </div>
                    {% endfor %}
                </div>

                <div class="form-field-group {% if form.phone_number.errors %}form-field-error{% endif %}">
                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                        {{ form.phone_number.label }}
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        {{ form.phone_number }}
                        {% if form.phone_number.help_text %}
                            <div class="help-text">{{ form.phone_number.help_text }}</div>
                        {% endif %}
                    </div>
                    {% for error in form.phone_number.errors %}
                        <div class="field-error-message">
                            <span class="error-icon">‚ùå</span>
                            {{ error }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
        <div id="additional-fields" style="display:none;" class="form-section additional-section">
            <div class="section-header">
                <h3 class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <p class="section-description">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
            </div>

            <div class="form-grid">
                <div class="form-field-group">
                    <label for="id_ceo_footing" class="form-label">–ü–æ–¥–ø–∏—Å—å –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏</label>
                    <div class="input-wrapper">
                        <select name="ceo_footing" id="id_ceo_footing" class="form-input">
                            <option value="ustav">–£—Å—Ç–∞–≤–∞</option>
                            <option value="attorney">–î–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</option>
                        </select>
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_ogrn" class="form-label">–û–ì–†–ù</label>
                    <div class="input-wrapper">
                        <input type="text" name="ogrn" id="id_ogrn" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_kpp" class="form-label">–ö–ü–ü</label>
                    <div class="input-wrapper">
                        <input type="text" name="kpp" id="id_kpp" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_r_s" class="form-label">–†/—Å</label>
                    <div class="input-wrapper">
                        <input type="text" name="r_s" id="id_r_s" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_bank" class="form-label">–ë–∞–Ω–∫</label>
                    <div class="input-wrapper">
                        <input type="text" name="bank" id="id_bank" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_bik" class="form-label">–ë–ò–ö</label>
                    <div class="input-wrapper">
                        <input type="text" name="bik" id="id_bik" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_k_s" class="form-label">–ö/—Å</label>
                    <div class="input-wrapper">
                        <input type="text" name="k_s" id="id_k_s" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group full-width">
                    <label for="id_address" class="form-label">–ê–¥—Ä–µ—Å</label>
                    <div class="input-wrapper">
                        <input type="text" name="address" id="id_address" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_email" class="form-label">Email</label>
                    <div class="input-wrapper">
                        <input type="email" name="email" id="id_email" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_ceo_title" class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                    <div class="input-wrapper">
                        <input type="text" name="ceo_title" id="id_ceo_title" class="form-input" />
                    </div>
                </div>

                <div class="form-field-group">
                    <label for="id_ceo_name" class="form-label">–§–ò–û</label>
                    <div class="input-wrapper">
                        <input type="text" name="ceo_name" id="id_ceo_name" class="form-input" />
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-submit">
                <span class="btn-text">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</span>
                <span class="btn-loading" style="display: none;">
                    <span class="spinner"></span>
                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                </span>
            </button>
        </div>
    </form>
</div>

<style>
.organization-create-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.organization-create-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.organization-create-title {
    font-size: clamp(1.75rem, 4vw, 2.25rem);
    font-weight: 700;
    color: #1a202c;
    margin: 0 0 0.5rem 0;
}

.organization-create-subtitle {
    font-size: 1rem;
    color: #718096;
    margin: 0;
}

.organization-form {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e2e8f0;
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 0.5rem 0;
}

.section-description {
    font-size: 0.875rem;
    color: #718096;
    margin: 0;
}

/* Type Selector */
.type-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.type-option {
    cursor: pointer;
}

.type-option input {
    display: none;
}

.type-card {
    position: relative;
    padding: 1.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    transition: all 0.3s ease;
    background: white;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.type-card:hover {
    border-color: #cbd5e0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.type-option input:checked + .type-card {
    border-color: #4299e1;
    background: #f7fafc;
}

.type-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.type-content h4 {
    margin: 0 0 0.25rem 0;
    font-weight: 600;
    color: #2d3748;
}

.type-content p {
    margin: 0;
    font-size: 0.875rem;
    color: #718096;
}

.type-check {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #e2e8f0;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.type-option input:checked + .type-card .type-check {
    border-color: #4299e1;
    background: #4299e1;
}

.type-option input:checked + .type-card .type-check::after {
    content: '‚úì';
    color: white;
    font-size: 0.75rem;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Form Grid */
.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

@media (min-width: 768px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .full-width {
        grid-column: 1 / -1;
    }
}

.form-field-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.required-asterisk {
    color: #e53e3e;
}

.input-wrapper {
    position: relative;
}

.form-input, .form-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: white;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.form-input:hover, .form-select:hover {
    border-color: #cbd5e0;
}

.form-field-error .form-input,
.form-field-error .form-select {
    border-color: #e53e3e;
}

.form-field-error .form-input:focus,
.form-field-error .form-select:focus {
    border-color: #e53e3e;
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
}

.field-error-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #e53e3e;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.error-icon {
    font-size: 0.75rem;
}

.help-text {
    font-size: 0.75rem;
    color: #718096;
    margin-top: 0.25rem;
}

/* Section Actions */
.section-actions {
    margin-top: 1.5rem;
}

.btn-outline {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    color: #4299e1;
    border: 2px solid #4299e1;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-outline:hover {
    background: #4299e1;
    color: white;
    transform: translateY(-1px);
}

.btn-icon {
    font-size: 1rem;
}

.btn-arrow {
    transition: transform 0.3s ease;
}

.additional-section.active .btn-arrow {
    transform: rotate(180deg);
}

/* Additional Section */
.additional-section {
    background: #f7fafc;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 1rem;
    border: 1px solid #e2e8f0;
}

/* Form Actions */
.form-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
}

.btn-submit {
    position: relative;
    padding: 0.875rem 2rem;
    background: #4299e1;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
}

.btn-submit:hover {
    background: #3182ce;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
}

.btn-submit:active {
    transform: translateY(0);
}

.btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Alert Styles */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 0.75rem;
}

.alert-error {
    background: #fed7d7;
    border: 1px solid #feb2b2;
    color: #c53030;
}

.alert-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.alert-content {
    flex: 1;
}

.alert-list {
    margin: 0.5rem 0 0 0;
    padding-left: 1.25rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('organization-form');
    const submitBtn = form.querySelector('.btn-submit');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const additionalFieldsBtn = document.getElementById('additional-fields-btn');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∏–ª–µ–π –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    const styleFormFields = () => {
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (!input.classList.contains('form-input') && !input.classList.contains('form-select')) {
                input.classList.add(input.tagName === 'SELECT' ? 'form-select' : 'form-input');
            }
        });
    };

    styleFormFields();

    form.addEventListener('submit', function(e) {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        let isValid = true;
        const isIndividual = document.querySelector('input[name="type"]:checked').value === 'individual';

        if (isIndividual) {
            const nameFlField = document.querySelector('input[name="name_fl"]');
            const phoneNumberField = document.querySelector('input[name="phone_number"]');

            if (!nameFlField.value.trim()) {
                isValid = false;
                nameFlField.closest('.form-field-group').classList.add('form-field-error');
            }
            if (!phoneNumberField.value.trim()) {
                isValid = false;
                phoneNumberField.closest('.form-field-group').classList.add('form-field-error');
            }
        } else {
            const innField = document.querySelector('input[name="inn"]');
            const nameField = document.querySelector('input[name="name"]');

            if (!innField.value.trim()) {
                isValid = false;
                innField.closest('.form-field-group').classList.add('form-field-error');
            }
            if (!nameField.value.trim()) {
                isValid = false;
                nameField.closest('.form-field-group').classList.add('form-field-error');
            }
        }

        if (!isValid) {
            e.preventDefault();
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
        btnText.style.display = 'none';
        btnLoading.style.display = 'flex';
        submitBtn.disabled = true;
    });

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
    const inputs = form.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            const fieldGroup = this.closest('.form-field-group');
            if (fieldGroup) {
                fieldGroup.classList.remove('form-field-error');
            }
        });
    });
});

function toggleFields() {
    const isIndividual = document.querySelector('input[name="type"]:checked').value === 'individual';
    const organizationFields = document.getElementById('organization-fields');
    const individualFields = document.getElementById('individual-fields');
    const formTitle = document.getElementById('form-title');
    const formSubtitle = document.getElementById('form-subtitle');

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    organizationFields.style.display = isIndividual ? 'none' : 'block';
    individualFields.style.display = isIndividual ? 'block' : 'none';

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    formTitle.innerText = isIndividual ? '–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ' : '–î–æ–±–∞–≤–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é';
    formSubtitle.innerText = isIndividual ? '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –ª–∏—Ü–µ' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ';

    updateRequiredFields(isIndividual);
}

function updateRequiredFields(isIndividual) {
    const nameFlField = document.querySelector('input[name="name_fl"]');
    const phoneNumberField = document.querySelector('input[name="phone_number"]');
    const innField = document.querySelector('input[name="inn"]');
    const nameField = document.querySelector('input[name="name"]');

    if (isIndividual) {
        nameFlField.setAttribute('required', '');
        phoneNumberField.setAttribute('required', '');
        innField.removeAttribute('required');
        nameField.removeAttribute('required');
    } else {
        innField.setAttribute('required', '');
        nameField.setAttribute('required', '');
        nameFlField.removeAttribute('required');
        phoneNumberField.removeAttribute('required');
    }
}

function toggleAdditionalFields() {
    const additionalFields = document.getElementById('additional-fields');
    const additionalBtn = document.getElementById('additional-fields-btn');
    const arrow = additionalBtn.querySelector('.btn-arrow');

    if (additionalFields.style.display === 'none') {
        additionalFields.style.display = 'block';
        additionalFields.classList.add('active');
        arrow.style.transform = 'rotate(180deg)';
        additionalBtn.innerHTML = '<span class="btn-icon">üìã</span>–°–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é<span class="btn-arrow">‚ñº</span>';
    } else {
        additionalFields.style.display = 'none';
        additionalFields.classList.remove('active');
        arrow.style.transform = 'rotate(0deg)';
        additionalBtn.innerHTML = '<span class="btn-icon">üìã</span>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è<span class="btn-arrow">‚ñº</span>';
    }
}
</script>
{% endblock %}