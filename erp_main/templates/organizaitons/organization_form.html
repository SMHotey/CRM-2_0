{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="organization-create-container">
    <div class="organization-create-header">
        <h1 id="form-title" class="organization-create-title">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h1>
        <p id="form-subtitle" class="organization-create-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</p>
    </div>

    <form method="post" id="organization-form" class="organization-form" novalidate enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="type" id="organization-type" value="legal">

        {% if form.non_field_errors %}
            <div class="alert alert-error" role="alert">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div class="alert-content">
                    <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:</strong>
                    <ul class="alert-list">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endif %}

        <!-- –¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">–¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h3>
            </div>
            <div class="type-selector">
                <label class="type-option">
                    <input type="radio" name="organization_type" value="legal" checked onchange="toggleOrganizationType()">
                    <div class="type-card">
                        <div class="type-icon">üè¢</div>
                        <div class="type-content">
                            <h4>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</h4>
                            <p>–û–û–û, –ê–û, –ó–ê–û</p>
                        </div>
                        <div class="type-check"></div>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="organization_type" value="individual_entrepreneur" onchange="toggleOrganizationType()">
                    <div class="type-card">
                        <div class="type-icon">üìä</div>
                        <div class="type-content">
                            <h4>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å</h4>
                            <p>–ò–ü</p>
                        </div>
                        <div class="type-check"></div>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="organization_type" value="person" onchange="toggleOrganizationType()">
                    <div class="type-card">
                        <div class="type-icon">üë§</div>
                        <div class="type-content">
                            <h4>–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</h4>
                            <p>–§–õ</p>
                        </div>
                        <div class="type-check"></div>
                    </div>
                </label>
            </div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ -->
        <div id="legal-fields" class="form-section">
            <div class="section-header">
                <h3 class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º –ª–∏—Ü–µ</h3>
            </div>
            <div class="form-grid">
                <div class="form-field-group">
                    <label class="form-label">
                        –¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <select name="legal_form" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="OOO">–û–û–û</option>
                            <option value="ZAO">–ó–ê–û</option>
                            <option value="AO">–ê–û</option>
                        </select>
                    </div>
                </div>

                <div class="form-field-group">
                    <label class="form-label">
                        –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" required>
                    </div>
                </div>

                <div class="form-field-group">
                    <label class="form-label">
                        –ò–ù–ù
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="inn" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù" required>
                    </div>
                </div>

                <div class="form-field-group">
                    <label class="form-label">
                        –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ (–Ω–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è)
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <select name="attached_to" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —é—Ä. –ª–∏—Ü–æ</option>
                            {% for legal_entity in legal_entities %}
                                <option value="{{ legal_entity.id }}">{{ legal_entity.name }} (–ò–ù–ù: {{ legal_entity.inn }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è –ò–ü -->
        <div id="individual-entrepreneur-fields" style="display:none;" class="form-section">
            <div class="section-header">
                <h3 class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ</h3>
            </div>
            <div class="form-grid">
                <div class="form-field-group">
                    <label class="form-label">
                        –§–ò–û –ò–ü
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ò–ü" required>
                    </div>
                </div>

                <div class="form-field-group">
                    <label class="form-label">
                        –ò–ù–ù
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="inn" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù" required>
                    </div>
                </div>

                <div class="form-field-group">
                    <label class="form-label">
                        –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ (–Ω–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è)
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <select name="attached_to" class="form-select" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —é—Ä. –ª–∏—Ü–æ</option>
                            {% for legal_entity in legal_entities %}
                                <option value="{{ legal_entity.id }}">{{ legal_entity.name }} (–ò–ù–ù: {{ legal_entity.inn }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞ -->
        <div id="person-fields" style="display:none;" class="form-section">
            <div class="section-header">
                <h3 class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –ª–∏—Ü–µ</h3>
            </div>
            <div class="form-grid">
                <div class="form-field-group">
                    <label class="form-label">
                        –§–ò–û
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û" required>
                    </div>
                </div>

                <div class="form-field-group">
                    <label class="form-label">
                        –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        <span class="required-asterisk">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="text" name="phone" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" required>
                    </div>
                </div>

                <div class="form-field-group full-width">
                    <label class="form-label">
                        –°–∫–∞–Ω –ø–∞—Å–ø–æ—Ä—Ç–∞
                    </label>
                    <div class="input-wrapper">
                        <input type="file" name="passport_scan" class="form-input" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —é—Ä.–ª–∏—Ü –∏ –ò–ü) -->
        <div id="additional-fields-section" class="section-actions">
            <button type="button" class="btn btn-outline" onclick="toggleAdditionalFields()" id="additional-fields-btn">
                <span class="btn-icon">üìã</span>
                –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                <span class="btn-arrow">‚ñº</span>
            </button>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
        <div id="additional-fields" style="display:none;" class="form-section additional-section">
            <div class="section-header">
                <h3 class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <p class="section-description">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
            </div>

            <!-- Email –∞–¥—Ä–µ—Å–∞ -->
            <div class="form-field-group full-width">
                <label class="form-label">Email –∞–¥—Ä–µ—Å–∞</label>
                <div id="email-container">
                    <div class="email-input-group">
                        <input type="email" name="emails[]" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
                        <button type="button" class="btn-remove" onclick="removeEmailField(this)">‚úï</button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline" onclick="addEmailField()">
                    <span class="btn-icon">‚úâÔ∏è</span>
                    –î–æ–±–∞–≤–∏—Ç—å email
                </button>
            </div>

            <!-- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
            <div class="form-field-group full-width">
                <label class="form-label">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</label>
                <div id="bank-accounts-container">
                    <div class="bank-account-group">
                        <div class="form-grid">
                            <div class="form-field-group">
                                <label class="form-label">–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</label>
                                <input type="text" name="r_s[]" class="form-input" placeholder="40702810...">
                            </div>
                            <div class="form-field-group">
                                <label class="form-label">–ë–∞–Ω–∫</label>
                                <input type="text" name="bank_names[]" class="form-input" placeholder="–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫">
                            </div>
                            <div class="form-field-group">
                                <label class="form-label">–ë–ò–ö</label>
                                <input type="text" name="biks[]" class="form-input" placeholder="044525225">
                            </div>
                            <div class="form-field-group">
                                <label class="form-label">–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç</label>
                                <input type="text" name="k_s[]" class="form-input" placeholder="301018104...">
                            </div>
                        </div>
                        <button type="button" class="btn-remove" onclick="removeBankAccount(this)">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline" onclick="addBankAccount()">
                    <span class="btn-icon">üè¶</span>
                    –î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
                </button>
            </div>

            <!-- –ü–æ–ª—è –¥–ª—è —é—Ä–ª–∏—Ü -->
            <div id="legal-additional-fields">
                <div class="form-grid">
                    <div class="form-field-group">
                        <label class="form-label">–û–ì–†–ù</label>
                        <div class="input-wrapper">
                            <input type="text" name="ogrn" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –û–ì–†–ù">
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label class="form-label">–ö–ü–ü</label>
                        <div class="input-wrapper">
                            <input type="text" name="kpp" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ö–ü–ü">
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</label>
                        <div class="input-wrapper">
                            <select name="director_position" class="form-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                                <option value="director">–î–∏—Ä–µ–∫—Ç–æ—Ä</option>
                                <option value="general_director">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label class="form-label">–§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</label>
                        <div class="input-wrapper">
                            <input type="text" name="director_name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è">
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-field-group full-width">
                        <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                        <div class="input-wrapper">
                            <textarea name="legal_address" class="form-input" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å"></textarea>
                        </div>
                    </div>
                    <div class="form-field-group full-width">
                        <label class="form-label">–ü–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å</label>
                        <div class="input-wrapper">
                            <textarea name="postal_address" class="form-input" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å"></textarea>
                        </div>
                        <div class="help-text">
                            <label class="checkbox-label">
                                <input type="checkbox" id="copy-legal-address" onchange="copyLegalAddress()">
                                –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –∞–¥—Ä–µ—Å–æ–º
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–ª—è –¥–ª—è –ò–ü -->
            <div id="ip-additional-fields" style="display:none;">
                <div class="form-grid">
                    <div class="form-field-group">
                        <label class="form-label">–û–ì–†–ù–ò–ü</label>
                        <div class="input-wrapper">
                            <input type="text" name="ogrnip" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –û–ì–†–ù–ò–ü">
                        </div>
                    </div>
                    <div class="form-field-group full-width">
                        <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                        <div class="input-wrapper">
                            <textarea name="legal_address" class="form-input" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-submit">
                <span class="btn-text">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</span>
                <span class="btn-loading" style="display: none;">
                    <span class="spinner"></span>
                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
                </span>
            </button>
            <a href="{% url 'organizations:organization_list' %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ -->
<div class="modal fade" id="duplicateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–û–±–Ω–∞—Ä—É–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç</h5>
            </div>
            <div class="modal-body">
                <p id="duplicateMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="takeOverOrganization()">–ó–∞–±—Ä–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</button>
                <button type="button" class="btn btn-warning" onclick="createDuplicate()">–°–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
</div>

<style>
/* –í—Å–µ –≤–∞—à–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
.organization-create-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.organization-create-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.organization-create-title {
    font-size: clamp(1.75rem, 4vw, 2.25rem);
    font-weight: 700;
    color: #1a202c;
    margin: 0 0 0.5rem 0;
}

.organization-create-subtitle {
    font-size: 1rem;
    color: #718096;
    margin: 0;
}

.organization-form {
    background: white;
    padding: 2.5rem;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e2e8f0;
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 0.5rem 0;
}

.section-description {
    font-size: 0.875rem;
    color: #718096;
    margin: 0;
}

.type-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

@media (max-width: 1024px) {
    .type-selector {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .type-selector {
        grid-template-columns: 1fr;
    }
}

.type-option {
    cursor: pointer;
}

.type-option input {
    display: none;
}

.type-card {
    position: relative;
    padding: 1.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    transition: all 0.3s ease;
    background: white;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    min-height: 120px;
    height: 100%;
}

.type-card:hover {
    border-color: #cbd5e0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.type-option input:checked + .type-card {
    border-color: #4299e1;
    background: #f7fafc;
}

.type-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.type-content {
    flex: 1;
    min-width: 0;
}

.type-content h4 {
    margin: 0 0 0.25rem 0;
    font-weight: 600;
    color: #2d3748;
    word-wrap: break-word;
}

.type-content p {
    margin: 0;
    font-size: 0.875rem;
    color: #718096;
    word-wrap: break-word;
}

.type-check {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #e2e8f0;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.type-option input:checked + .type-card .type-check {
    border-color: #4299e1;
    background: #4299e1;
}

.type-option input:checked + .type-card .type-check::after {
    content: '‚úì';
    color: white;
    font-size: 0.75rem;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

@media (min-width: 768px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .full-width {
        grid-column: 1 / -1;
    }
}

.form-field-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.required-asterisk {
    color: #e53e3e;
}

.input-wrapper {
    position: relative;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: white;
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.form-input:hover, .form-select:hover, .form-textarea:hover {
    border-color: #cbd5e0;
}

.form-field-error .form-input,
.form-field-error .form-select,
.form-field-error .form-textarea {
    border-color: #e53e3e;
}

.form-field-error .form-input:focus,
.form-field-error .form-select:focus,
.form-field-error .form-textarea:focus {
    border-color: #e53e3e;
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
}

.field-error-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #e53e3e;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.error-icon {
    font-size: 0.75rem;
}

.help-text {
    font-size: 0.75rem;
    color: #718096;
    margin-top: 0.25rem;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
}

.section-actions {
    margin-top: 1.5rem;
}

.btn-outline {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    color: #4299e1;
    border: 2px solid #4299e1;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-outline:hover {
    background: #4299e1;
    color: white;
    transform: translateY(-1px);
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #718096;
    color: white;
    border: 2px solid #718096;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: #4a5568;
    color: white;
    transform: translateY(-1px);
}

.btn-icon {
    font-size: 1rem;
}

.btn-arrow {
    transition: transform 0.3s ease;
}

.additional-section.active .btn-arrow {
    transform: rotate(180deg);
}

.additional-section {
    background: #f7fafc;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 1rem;
    border: 1px solid #e2e8f0;
}

.form-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 1rem;
    justify-content: flex-start;
}

.btn-submit {
    position: relative;
    padding: 0.875rem 2rem;
    background: #4299e1;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-submit:hover {
    background: #3182ce;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
}

.btn-submit:active {
    transform: translateY(0);
}

.btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 0.75rem;
}

.alert-error {
    background: #fed7d7;
    border: 1px solid #feb2b2;
    color: #c53030;
}

.alert-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.alert-content {
    flex: 1;
}

.alert-list {
    margin: 0.5rem 0 0 0;
    padding-left: 1.25rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π */
.email-input-group, .bank-account-group {
    position: relative;
    margin-bottom: 1rem;
    padding: 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
}

.btn-remove {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: #e53e3e;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.btn-remove:hover {
    background: #c53030;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π */
.form-input:read-only {
    background-color: #f7fafc;
    color: #718096;
    cursor: not-allowed;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö */
.error-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #fed7d7;
    border: 1px solid #feb2b2;
    color: #c53030;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10000;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.notification-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.notification-text {
    font-weight: 500;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–æ–∫ –ø–æ–ª–µ–π */
.form-field-error .form-label {
    color: #e53e3e;
}

.form-field-error .form-input,
.form-field-error .form-select,
.form-field-error .form-textarea {
    border-color: #e53e3e;
    background-color: #fff5f5;
}

.form-field-error .form-input:focus,
.form-field-error .form-select:focus,
.form-field-error .form-textarea:focus {
    border-color: #e53e3e;
    box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    background-color: #fff5f5;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤
    window.toggleOrganizationType = function() {
        const orgType = document.querySelector('input[name="organization_type"]:checked');
        if (!orgType) return;

        const typeValue = orgType.value;
        document.getElementById('organization-type').value = typeValue;

        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è
        const allFields = ['legal-fields', 'individual-entrepreneur-fields', 'person-fields'];
        allFields.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
        switch(typeValue) {
            case 'legal':
                document.getElementById('legal-fields').style.display = 'block';
                document.getElementById('additional-fields-section').style.display = 'block';
                document.getElementById('legal-additional-fields').style.display = 'block';
                document.getElementById('ip-additional-fields').style.display = 'none';
                break;
            case 'individual_entrepreneur':
                document.getElementById('individual-entrepreneur-fields').style.display = 'block';
                document.getElementById('additional-fields-section').style.display = 'block';
                document.getElementById('legal-additional-fields').style.display = 'none';
                document.getElementById('ip-additional-fields').style.display = 'block';
                break;
            case 'person':
                document.getElementById('person-fields').style.display = 'block';
                document.getElementById('additional-fields-section').style.display = 'none';
                document.getElementById('additional-fields').style.display = 'none';
                break;
        }

        updateFormTitle(typeValue);
    };

    function updateFormTitle(orgType) {
        const titles = {
            'legal': ['–î–æ–±–∞–≤–∏—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–º –ª–∏—Ü–µ'],
            'individual_entrepreneur': ['–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–µ'],
            'person': ['–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –ª–∏—Ü–µ']
        };

        const [title, subtitle] = titles[orgType] || ['–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é'];

        const formTitle = document.getElementById('form-title');
        const formSubtitle = document.getElementById('form-subtitle');

        if (formTitle) formTitle.innerText = title;
        if (formSubtitle) formSubtitle.innerText = subtitle;
    }

    window.toggleAdditionalFields = function() {
        const additionalFields = document.getElementById('additional-fields');
        const additionalBtn = document.getElementById('additional-fields-btn');

        if (!additionalFields || !additionalBtn) return;

        const arrow = additionalBtn.querySelector('.btn-arrow');
        const isHidden = additionalFields.style.display === 'none';

        if (isHidden) {
            additionalFields.style.display = 'block';
            additionalFields.classList.add('active');
            arrow.style.transform = 'rotate(180deg)';
            additionalBtn.innerHTML = '<span class="btn-icon">üìã</span>–°–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é<span class="btn-arrow">‚ñº</span>';
        } else {
            additionalFields.style.display = 'none';
            additionalFields.classList.remove('active');
            arrow.style.transform = 'rotate(0deg)';
            additionalBtn.innerHTML = '<span class="btn-icon">üìã</span>–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è<span class="btn-arrow">‚ñº</span>';
        }
    };

    window.addEmailField = function(value = '') {
        const container = document.getElementById('email-container');
        if (container) {
            const newEmailGroup = document.createElement('div');
            newEmailGroup.className = 'email-input-group';
            newEmailGroup.innerHTML = `
                <input type="email" name="emails[]" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email" value="${value}">
                <button type="button" class="btn-remove" onclick="removeEmailField(this)">‚úï</button>
            `;
            container.appendChild(newEmailGroup);
        }
    };

    window.removeEmailField = function(button) {
        const container = document.getElementById('email-container');
        if (container && container.children.length > 1) {
            button.parentElement.remove();
        } else if (container) {
            const input = button.parentElement.querySelector('input');
            if (input) input.value = '';
        }
    };

    window.addBankAccount = function(accountData = {}) {
        const container = document.getElementById('bank-accounts-container');
        if (container) {
            const newAccount = document.createElement('div');
            newAccount.className = 'bank-account-group';
            newAccount.innerHTML = `
                <div class="form-grid">
                    <div class="form-field-group">
                        <label class="form-label">–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</label>
                        <input type="text" name="r_s[]" class="form-input" placeholder="40702810..." value="${accountData.r_s || ''}">
                    </div>
                    <div class="form-field-group">
                        <label class="form-label">–ë–∞–Ω–∫</label>
                        <input type="text" name="bank_names[]" class="form-input" placeholder="–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫" value="${accountData.bank || ''}">
                    </div>
                    <div class="form-field-group">
                        <label class="form-label">–ë–ò–ö</label>
                        <input type="text" name="biks[]" class="form-input" placeholder="044525225" value="${accountData.bik || ''}">
                    </div>
                    <div class="form-field-group">
                        <label class="form-label">–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç</label>
                        <input type="text" name="k_s[]" class="form-input" placeholder="301018104..." value="${accountData.k_s || ''}">
                    </div>
                </div>
                <button type="button" class="btn-remove" onclick="removeBankAccount(this)">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
            `;
            container.appendChild(newAccount);
        }
    };

    window.removeBankAccount = function(button) {
        const container = document.getElementById('bank-accounts-container');
        if (container && container.children.length > 1) {
            button.parentElement.remove();
        }
    };

    window.copyLegalAddress = function() {
        const copyCheckbox = document.getElementById('copy-legal-address');
        const legalAddress = document.querySelector('textarea[name="legal_address"]');
        const postalAddress = document.querySelector('textarea[name="postal_address"]');
        
        if (copyCheckbox.checked && legalAddress && postalAddress) {
            postalAddress.value = legalAddress.value;
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ AJAX
    const form = document.getElementById('organization-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('.btn-submit');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            submitBtn.disabled = true;

            const formData = new FormData(form);
            
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{% url 'organizations:organization_list' %}";
                } else if (data.duplicate) {
                    document.getElementById('duplicateMessage').textContent = data.message;
                    document.getElementById('duplicateModal').dataset.existingId = data.existing_id;
                    new bootstrap.Modal(document.getElementById('duplicateModal')).show();
                } else {
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + JSON.stringify(data.errors));
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            })
            .finally(() => {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                btnText.style.display = 'flex';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            });
        });
    }

    function showError(message) {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        const notification = document.createElement('div');
        notification.className = 'error-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">‚ùå</span>
                <span class="notification-text">${message}</span>
            </div>
        `;
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    window.takeOverOrganization = function() {
        const existingId = document.getElementById('duplicateModal').dataset.existingId;
        
        fetch("{% url 'organizations:organization_takeover' %}", {
            method: 'POST',
            body: JSON.stringify({organization_id: existingId}),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{% url 'organizations:organization_list' %}";
            }
        });
    };

    window.createDuplicate = function() {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
        const form = document.getElementById('organization-form');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'force_create';
        input.value = 'true';
        form.appendChild(input);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = bootstrap.Modal.getInstance(document.getElementById('duplicateModal'));
        modal.hide();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
        form.dispatchEvent(new Event('submit'));
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    toggleOrganizationType();
});
</script>
{% endblock %}