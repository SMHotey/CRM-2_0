{% extends "base.html" %}
{% load my_filters %}
{% load static %}

{% block content %}
<div class="shipment-day-detail">
    <!-- Header -->
    <div class="detail-header">
        <h1 class="detail-title">Отгрузки из цеха №{{ workshop }}</h1>
        <p class="detail-subtitle">{{ date|date:"d F Y" }}</p>
    </div>

    <!-- Orders Data Storage -->
    <div id="orders-data" style="display:none;">
        {% for order in orders %}
            {{ order.pk }}||{{ order.created_at|date:"Y-m-d H:i:s" }}##
        {% endfor %}
    </div>

    <!-- Shipments Table -->
    <div class="table-container glass-effect">
        <div class="table-responsive">
            <table class="shipments-table">
                <thead>
                    <tr>
                        <th>Время</th>
                        <th>Номер заявки</th>
                        <th>Тип отгрузки</th>
                        <th>Марка автомобиля</th>
                        <th>Гос. номер</th>
                        <th>Адрес доставки</th>
                        <th>Комментарии</th>
                        <th>Отметка об отгрузке</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for time in times %}
                    {% with shipment=shipments|get_item:time %}
                    <tr data-time="{{ time|time:'H:i' }}" {% if not shipment %}class="empty-row"{% endif %}>
                        <td class="time-cell">{{ time|time:"H:i" }}</td>

                        {% if shipment %}
                            <td class="order-pk">{{ shipment.order.pk|default:"" }}</td>
                            <td class="order-type">{{ shipment.order_items.type|default:"" }}</td>
                            <td class="car-brand">{{ shipment.car_info.brand|default:"" }}</td>
                            <td class="car-number">{{ shipment.car_info.number|default:"" }}</td>
                            <td class="address">{{ shipment.address|default:"" }}</td>
                            <td class="comments">{{ shipment.driver_info.comments|default:"" }}</td>
                            <td class="shipment-mark">{{ shipment.driver_info.shipment_mark|default:"" }}</td>
                            <td class="actions-cell">
                                <div class="action-buttons">
                                    {% if shipment.user == request.user or request.user.is_superuser %}
                                        <button class="btn btn-edit edit-btn"
                                                data-shipment-id="{{ shipment.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-delete delete-btn"
                                                data-shipment-id="{{ shipment.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% else %}
                                        <span class="no-permission">Только для создателя</span>
                                    {% endif %}
                                </div>
                            </td>
                        {% else %}
                            <td class="order-pk"></td>
                            <td class="order-type"></td>
                            <td class="car-brand"></td>
                            <td class="car-number"></td>
                            <td class="address"></td>
                            <td class="comments"></td>
                            <td class="shipment-mark"></td>
                            <td class="actions-cell">
                                <button class="btn btn-create create-btn"
                                        data-time="{{ time|time:'H:i' }}">
                                    <i class="bi bi-plus-circle"></i>
                                    Создать
                                </button>
                            </td>
                        {% endif %}
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Back to Calendar -->
    <div class="back-container">
        <a href="{% url 'calendar' %}" class="btn btn-back">
            <i class="bi bi-arrow-left"></i>
            Назад к календарю
        </a>
    </div>
</div>

<style>
.shipment-day-detail {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

.detail-header {
    text-align: center;
    margin-bottom: 2rem;
}

.detail-title {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.detail-subtitle {
    color: #718096;
    font-size: 1.25rem;
    margin: 0;
}

/* Table Container */
.table-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
}

.table-responsive {
    overflow-x: auto;
}

/* Shipments Table */
.shipments-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.shipments-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 0.75rem;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    border: none;
}

.shipments-table td {
    padding: 0.75rem;
    text-align: center;
    vertical-align: middle;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shipments-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.05);
}

.shipments-table tbody tr.empty-row {
    background: rgba(248, 250, 252, 0.8);
}

.shipments-table tbody tr.empty-row:hover {
    background: rgba(102, 126, 234, 0.08);
}

/* Cells */
.time-cell {
    font-weight: 600;
    color: #2d3748;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 8px 0 0 8px;
}

.actions-cell {
    border-radius: 0 8px 8px 0;
}

/* Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    align-items: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
    font-size: 0.8rem;
}

.btn-create {
    background: #48bb78;
    color: white;
}

.btn-create:hover {
    background: #38a169;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
}

.btn-edit {
    background: #ed8936;
    color: white;
}

.btn-edit:hover {
    background: #dd7713;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
}

.btn-delete {
    background: #f56565;
    color: white;
}

.btn-delete:hover {
    background: #e53e3e;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
}

.btn-back {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.75rem 1.5rem;
}

.btn-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    color: white;
}

.no-permission {
    color: #a0aec0;
    font-size: 0.8rem;
    font-style: italic;
}

/* Editing Styles */
.editing input,
.editing select {
    width: 100%;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    padding: 0.5rem;
    font-size: 0.8rem;
    background: white;
}

.editing input:focus,
.editing select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.editing .order-pk,
.editing .order-type {
    min-width: 120px;
}

.editing .car-brand,
.editing .car-number {
    min-width: 100px;
}

.editing .address {
    min-width: 150px;
}

.editing .comments,
.editing .shipment-mark {
    min-width: 120px;
}

/* Loading States */
.btn.loading {
    opacity: 0.7;
    pointer-events: none;
}

.spinner-border {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    vertical-align: text-bottom;
    border: 0.2em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

/* Back Container */
.back-container {
    text-align: center;
    margin-top: 2rem;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .shipment-day-detail {
        padding: 0.5rem;
    }

    .table-container {
        padding: 1rem;
    }

    .shipments-table {
        font-size: 0.8rem;
    }

    .shipments-table th,
    .shipments-table td {
        padding: 0.5rem 0.25rem;
    }
}

@media (max-width: 768px) {
    .detail-title {
        font-size: 1.5rem;
    }

    .detail-subtitle {
        font-size: 1rem;
    }

    .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
    }

    .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }

    .shipments-table {
        min-width: 800px;
    }
}

@media (max-width: 480px) {
    .shipment-day-detail {
        padding: 0.25rem;
    }

    .table-container {
        padding: 0.5rem;
        border-radius: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const shipmentTypes = ['самовывоз', 'наша', 'ТК'];

    // Функция для получения данных заказов
    function getOrdersData() {
        const dataElement = document.getElementById('orders-data');
        const dataText = dataElement.textContent.trim();
        const orders = [];

        if (dataText) {
            const items = dataText.split('##').filter(i => i);
            items.forEach(item => {
                const parts = item.split('||');
                if (parts.length === 2) {
                    orders.push({
                        pk: parts[0],
                        created_at: parts[1]
                    });
                }
            });
        }

        return orders;
    }

    // Функция создания выпадающего списка заказов
    function createOrderSelect(currentValue) {
        const orders = getOrdersData();
        const select = document.createElement('select');
        select.className = 'form-select-sm';

        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Выберите заявку --';
        select.appendChild(emptyOption);

        orders.forEach(order => {
            const option = document.createElement('option');
            option.value = order.pk;
            option.textContent = `Заявка ${order.pk}`;
            if (order.pk === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        return select;
    }

    // Функция создания выпадающего списка типов отгрузки
    function createTypeSelect(currentValue) {
        const select = document.createElement('select');
        select.className = 'form-select-sm';

        shipmentTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            if (type === currentValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        return select;
    }

    // Функция входа в режим редактирования
    function enterEditMode(row, button, isNew) {
        row.classList.add('editing');

        // Сохраняем исходное состояние кнопки
        button.setAttribute('data-original-html', button.innerHTML);

        // Обновляем кнопку
        button.innerHTML = '<i class="bi bi-check"></i> Сохранить';
        button.classList.remove('btn-create', 'btn-edit');
        button.classList.add('btn-primary');
        button.style.background = '#667eea';

        // Номер заявки
        const orderPkCell = row.querySelector('.order-pk');
        const currentOrderPk = orderPkCell.textContent.trim();
        orderPkCell.innerHTML = '';
        orderPkCell.appendChild(createOrderSelect(currentOrderPk));

        // Тип отгрузки
        const orderTypeCell = row.querySelector('.order-type');
        const currentType = orderTypeCell.textContent.trim();
        orderTypeCell.innerHTML = '';
        orderTypeCell.appendChild(createTypeSelect(currentType));

        // Остальные поля
        ['car-brand', 'car-number', 'address', 'comments', 'shipment-mark'].forEach(cls => {
            const cell = row.querySelector(`.${cls}`);
            const currentValue = cell.textContent.trim();
            cell.innerHTML = `<input type="text" value="${currentValue}" class="form-control-sm">`;
        });
    }

    // Функция выхода из режима редактирования
    function exitEditMode(row, button, isNew) {
        row.classList.remove('editing');

        // Восстанавливаем кнопку
        if (isNew) {
            button.innerHTML = '<i class="bi bi-plus-circle"></i> Создать';
            button.classList.remove('btn-primary');
            button.classList.add('btn-create');
            button.style.background = '';
        } else {
            button.innerHTML = '<i class="bi bi-pencil"></i>';
            button.classList.remove('btn-primary');
            button.classList.add('btn-edit');
            button.style.background = '';
        }
    }

    // Функция обновления строки после сохранения
    function updateRowAfterSave(row, data, isNew) {
        row.querySelector('.order-pk').textContent = data.order || '';
        row.querySelector('.order-type').textContent = data.order_type || '';
        row.querySelector('.car-brand').textContent = data.car_brand || '';
        row.querySelector('.car-number').textContent = data.car_number || '';
        row.querySelector('.address').textContent = data.address || '';
        row.querySelector('.comments').textContent = data.comments || '';
        row.querySelector('.shipment-mark').textContent = data.shipment_mark || '';

        if (isNew) {
            row.classList.remove('empty-row');
        }
    }

    // Функция сохранения отгрузки
    function saveShipment(row, button, isNew) {
        const formData = new FormData();
        const shipmentId = button.getAttribute('data-shipment-id') || '';

        // Собираем данные формы
        formData.append('shipment_id', shipmentId);
        formData.append('order', row.querySelector('.order-pk select').value);
        formData.append('order_type', row.querySelector('.order-type select').value);
        formData.append('car_brand', row.querySelector('.car-brand input').value);
        formData.append('car_number', row.querySelector('.car-number input').value);
        formData.append('address', row.querySelector('.address input').value);
        formData.append('comments', row.querySelector('.comments input').value);
        formData.append('shipment_mark', row.querySelector('.shipment-mark input').value);

        // Только для новых отгрузок
        if (isNew) {
            formData.append('date', '{{ date|date:"Y-m-d" }}');
            formData.append('time', row.getAttribute('data-time'));
            formData.append('workshop', '{{ workshop }}');
        }

        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // Показываем индикатор загрузки
        button.disabled = true;
        button.classList.add('loading');
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...';

        fetch('{% url "save_shipment" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Обновляем данные в таблице
                updateRowAfterSave(row, data, isNew);

                // Обновляем кнопку если это новая запись
                if (isNew) {
                    const actionsCell = row.querySelector('.actions-cell');
                    actionsCell.innerHTML = `
                        <div class="action-buttons">
                            <button class="btn btn-edit edit-btn"
                                    data-shipment-id="${data.shipment_id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-delete delete-btn"
                                    data-shipment-id="${data.shipment_id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;

                    // Назначаем обработчики для новых кнопок
                    actionsCell.querySelector('.edit-btn').addEventListener('click', editHandler);
                    actionsCell.querySelector('.delete-btn').addEventListener('click', deleteHandler);
                } else {
                    exitEditMode(row, button, false);
                    button.disabled = false;
                    button.classList.remove('loading');
                }

                // Показываем уведомление об успехе
                showNotification('Отгрузка успешно сохранена', 'success');
            } else {
                throw new Error(data.message || 'Неизвестная ошибка сервера');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            button.disabled = false;
            button.classList.remove('loading');
            exitEditMode(row, button, isNew);
            showNotification(`Ошибка сохранения: ${error.message}`, 'error');
        });
    }

    // Функция удаления отгрузки
    function deleteShipment(button) {
        if (!confirm('Вы уверены, что хотите удалить эту отгрузку?')) {
            return;
        }

        const shipmentId = button.getAttribute('data-shipment-id');
        const row = button.closest('tr');
        const actionsCell = row.querySelector('.actions-cell');

        // Показываем индикатор загрузки
        button.disabled = true;
        button.classList.add('loading');
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Удаление...';

        fetch(`{% url 'delete_shipment' 0 %}`.replace('0', shipmentId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Очищаем строку
                row.classList.add('empty-row');
                row.querySelectorAll('td:not(:first-child):not(:last-child)').forEach(cell => {
                    cell.textContent = '';
                });

                // Меняем кнопки на "Создать"
                actionsCell.innerHTML = `
                    <button class="btn btn-create create-btn"
                            data-time="${row.getAttribute('data-time')}">
                        <i class="bi bi-plus-circle"></i>
                        Создать
                    </button>
                `;

                // Назначаем обработчик для новой кнопки
                actionsCell.querySelector('.create-btn').addEventListener('click', createHandler);

                showNotification('Отгрузка успешно удалена', 'success');
            } else {
                throw new Error(data.message || 'Неизвестная ошибка сервера');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            button.disabled = false;
            button.classList.remove('loading');
            button.innerHTML = '<i class="bi bi-trash"></i>';
            showNotification(`Ошибка удаления: ${error.message}`, 'error');
        });
    }

    // Функция показа уведомлений
    function showNotification(message, type) {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        // Стили для уведомления
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#48bb78' : '#f56565'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        // Удаляем уведомление через 3 секунды
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Обработчики событий
    function editHandler() {
        const row = this.closest('tr');
        if (row.classList.contains('editing')) {
            saveShipment(row, this, false);
        } else {
            enterEditMode(row, this, false);
        }
    }

    function createHandler() {
        const row = this.closest('tr');
        if (row.classList.contains('editing')) {
            saveShipment(row, this, true);
        } else {
            enterEditMode(row, this, true);
        }
    }

    function deleteHandler() {
        deleteShipment(this);
    }

    // Назначаем обработчики
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', editHandler);
    });

    document.querySelectorAll('.create-btn').forEach(btn => {
        btn.addEventListener('click', createHandler);
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', deleteHandler);
    });
});
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
</style>
{% endblock %}