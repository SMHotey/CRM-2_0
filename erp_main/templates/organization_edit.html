{% extends 'base.html' %}
{% block content %}

<div class="organization-create-container">
    <div class="organization-create-header">
        <h1 class="organization-create-title">
            {% if organization.organization_type == 'legal_entity' %}
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ
            {% elif organization.organization_type == 'individual_entrepreneur' %}
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è
            {% else %}
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ
            {% endif %}
        </h1>
        <p class="organization-create-subtitle">
            {{ organization.name|default:organization.name_fl }}
        </p>
    </div>

    <form method="post" class="organization-form" novalidate enctype="multipart/form-data">
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="alert alert-error">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div class="alert-content">
                    <strong>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏:</strong>
                    <ul class="alert-list">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endif %}

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            </div>
            <div class="form-grid">
                {% for field in form %}
                    {% if field.name not in 'emails,bank_accounts,contract_template,custom_contract_template' %}
                    <div class="form-field-group {% if field.errors %}form-field-error{% endif %}">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            {{ field.label }}
                            {% if field.field.required %}<span class="required-asterisk">*</span>{% endif %}
                        </label>
                        <div class="input-wrapper">
                            {{ field }}
                        </div>
                        {% for error in field.errors %}
                            <div class="field-error-message">
                                <span class="error-icon">‚ùå</span>
                                {{ error }}
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —é—Ä–ª–∏—Ü –∏ –ò–ü -->
        {% if organization.organization_type != 'physical_person' %}
        <!-- Emails -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">Email –∞–¥—Ä–µ—Å–∞</h3>
            </div>
            <div id="email-container">
                {% for email in emails %}
                <div class="email-input-group">
                    <input type="email" name="emails[]" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email" value="{{ email.email }}">
                    <button type="button" class="btn-remove" onclick="removeEmailField(this)">‚úï</button>
                </div>
                {% empty %}
                <div class="email-input-group">
                    <input type="email" name="emails[]" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
                    <button type="button" class="btn-remove" onclick="removeEmailField(this)">‚úï</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-outline" onclick="addEmailField()">
                <span class="btn-icon">‚úâÔ∏è</span>
                –î–æ–±–∞–≤–∏—Ç—å email
            </button>
            {{ form.emails }}
        </div>

        <!-- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
            </div>
            <div id="bank-accounts-container">
                {% for account in bank_accounts %}
                <div class="bank-account-group">
                    <div class="form-grid">
                        <div class="form-field-group">
                            <label class="form-label">–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</label>
                            <input type="text" name="bank_r_s[]" class="form-input" placeholder="40702810..." value="{{ account.r_s }}">
                        </div>
                        <div class="form-field-group">
                            <label class="form-label">–ë–∞–Ω–∫</label>
                            <input type="text" name="bank_name[]" class="form-input" placeholder="–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫" value="{{ account.bank }}">
                        </div>
                        <div class="form-field-group">
                            <label class="form-label">–ë–ò–ö</label>
                            <input type="text" name="bank_bik[]" class="form-input" placeholder="044525225" value="{{ account.bik }}">
                        </div>
                        <div class="form-field-group">
                            <label class="form-label">–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç</label>
                            <input type="text" name="bank_k_s[]" class="form-input" placeholder="301018104..." value="{{ account.k_s }}">
                        </div>
                    </div>
                    <button type="button" class="btn-remove" onclick="removeBankAccount(this)">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
                </div>
                {% empty %}
                <div class="bank-account-group">
                    <div class="form-grid">
                        <div class="form-field-group">
                            <label class="form-label">–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</label>
                            <input type="text" name="bank_r_s[]" class="form-input" placeholder="40702810...">
                        </div>
                        <div class="form-field-group">
                            <label class="form-label">–ë–∞–Ω–∫</label>
                            <input type="text" name="bank_name[]" class="form-input" placeholder="–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫">
                        </div>
                        <div class="form-field-group">
                            <label class="form-label">–ë–ò–ö</label>
                            <input type="text" name="bank_bik[]" class="form-input" placeholder="044525225">
                        </div>
                        <div class="form-field-group">
                            <label class="form-label">–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç</label>
                            <input type="text" name="bank_k_s[]" class="form-input" placeholder="301018104...">
                        </div>
                    </div>
                    <button type="button" class="btn-remove" onclick="removeBankAccount(this)">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-outline" onclick="addBankAccount()">
                <span class="btn-icon">üè¶</span>
                –î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
            </button>
            {{ form.bank_accounts }}
        </div>

        <!-- –®–∞–±–ª–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤ -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">–®–∞–±–ª–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞</h3>
            </div>
            <div class="form-grid">
                <div class="form-field-group">
                    <label for="{{ form.contract_template.id_for_label }}" class="form-label">
                        –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω
                    </label>
                    <div class="input-wrapper">
                        {{ form.contract_template }}
                    </div>
                </div>
                <div class="form-field-group">
                    <label for="{{ form.custom_contract_template.id_for_label }}" class="form-label">
                        –°–≤–æ–π —à–∞–±–ª–æ–Ω
                    </label>
                    <div class="input-wrapper">
                        {{ form.custom_contract_template }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
            <a href="{% url 'organization_detail' organization.pk %}" class="btn btn-outline">
                –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ç–µ –∂–µ —Å—Ç–∏–ª–∏ —á—Ç–æ –∏ –≤ organization_add.html -->
<style>
.organization-create-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

.organization-create-header {
    text-align: center;
    margin-bottom: 2.5rem;
}

.organization-create-title {
    font-size: clamp(1.75rem, 4vw, 2.25rem);
    font-weight: 700;
    color: #1a202c;
    margin: 0 0 0.5rem 0;
}

.organization-create-subtitle {
    font-size: 1rem;
    color: #718096;
    margin: 0;
}

.organization-form {
    background: white;
    padding: 2.5rem;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã organization_add.html */
</style>

<script>
// –¢–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ JavaScript —á—Ç–æ –∏ –≤ organization_add.html
function addEmailField(value = '') {
    const container = document.getElementById('email-container');
    const newEmailGroup = document.createElement('div');
    newEmailGroup.className = 'email-input-group';
    newEmailGroup.innerHTML = `
        <input type="email" name="emails[]" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ email" value="${value}">
        <button type="button" class="btn-remove" onclick="removeEmailField(this)">‚úï</button>
    `;
    container.appendChild(newEmailGroup);
    updateEmailsHiddenField();
}

function removeEmailField(button) {
    const container = document.getElementById('email-container');
    if (container.children.length > 1) {
        button.parentElement.remove();
    } else {
        button.parentElement.querySelector('input').value = '';
    }
    updateEmailsHiddenField();
}

function addBankAccount(accountData = {}) {
    const container = document.getElementById('bank-accounts-container');
    const newAccount = document.createElement('div');
    newAccount.className = 'bank-account-group';
    newAccount.innerHTML = `
        <div class="form-grid">
            <div class="form-field-group">
                <label class="form-label">–†–∞—Å—á–µ—Ç–Ω—ã–π —Å—á–µ—Ç</label>
                <input type="text" name="bank_r_s[]" class="form-input" placeholder="40702810..." value="${accountData.r_s || ''}">
            </div>
            <div class="form-field-group">
                <label class="form-label">–ë–∞–Ω–∫</label>
                <input type="text" name="bank_name[]" class="form-input" placeholder="–ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫" value="${accountData.bank || ''}">
            </div>
            <div class="form-field-group">
                <label class="form-label">–ë–ò–ö</label>
                <input type="text" name="bank_bik[]" class="form-input" placeholder="044525225" value="${accountData.bik || ''}">
            </div>
            <div class="form-field-group">
                <label class="form-label">–ö–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á–µ—Ç</label>
                <input type="text" name="bank_k_s[]" class="form-input" placeholder="301018104..." value="${accountData.k_s || ''}">
            </div>
        </div>
        <button type="button" class="btn-remove" onclick="removeBankAccount(this)">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</button>
    `;
    container.appendChild(newAccount);
    updateBankAccountsHiddenField();
}

function removeBankAccount(button) {
    const container = document.getElementById('bank-accounts-container');
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
    updateBankAccountsHiddenField();
}

function updateEmailsHiddenField() {
    const emailInputs = document.querySelectorAll('input[name="emails[]"]');
    const emails = Array.from(emailInputs).map(input => input.value.trim()).filter(email => email);
    document.getElementById('id_emails').value = emails.join(',');
}

function updateBankAccountsHiddenField() {
    const bankAccounts = [];
    document.querySelectorAll('.bank-account-group').forEach(group => {
        const r_s = group.querySelector('input[name="bank_r_s[]"]')?.value.trim() || '';
        const bank = group.querySelector('input[name="bank_name[]"]')?.value.trim() || '';
        const bik = group.querySelector('input[name="bank_bik[]"]')?.value.trim() || '';
        const k_s = group.querySelector('input[name="bank_k_s[]"]')?.value.trim() || '';

        if (r_s || bank) {
            bankAccounts.push({ r_s, bank, bik, k_s });
        }
    });
    document.getElementById('id_bank_accounts').value = JSON.stringify(bankAccounts);
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
document.addEventListener('input', function(e) {
    if (e.target.name === 'emails[]') {
        updateEmailsHiddenField();
    }
    if (e.target.name?.startsWith('bank_')) {
        updateBankAccountsHiddenField();
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    updateEmailsHiddenField();
    updateBankAccountsHiddenField();
});
</script>
{% endblock %}