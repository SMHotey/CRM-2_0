{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<style>
    .form-select {
        width: auto;
        min-width: 120px;
        padding: 0.2rem;
        transition: var(--transition-smooth);
    }

    .hidden {
        display: none;
    }

    table tr:hover {
        background-color: rgba(55, 177, 222, 0.08);
        transition: var(--transition-smooth);
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
        overflow: hidden;
    }

    .card:hover {
        box-shadow: var(--shadow-medium);
        transform: translateY(-2px);
    }

    .card-header {
        background: rgba(55, 177, 222, 0.1);
        border-bottom: 1px solid rgba(55, 177, 222, 0.2);
        padding: 1.25rem 1.5rem;
        font-weight: 600;
    }

    .table {
        margin-bottom: 0;
    }

    .table th {
        background: rgba(55, 177, 222, 0.15);
        border-bottom: 2px solid rgba(55, 177, 222, 0.3);
        font-weight: 600;
        color: #2d3748;
    }

    .btn {
        border-radius: 10px;
        font-weight: 500;
        transition: var(--transition-smooth);
        border: none;
    }

    .btn-primary {
        background: var(--primary-gradient);
        box-shadow: 0 4px 15px rgba(79, 151, 199, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 151, 199, 0.4);
    }

    .btn-link {
        color: #4F97C7;
        text-decoration: none;
        transition: var(--transition-smooth);
    }

    .btn-link:hover {
        color: #3a7bb0;
        transform: translateY(-1px);
    }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-in_query { background: rgba(108, 117, 125, 0.1); color: #6c757d; }
    .status-product { background: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    .status-ready { background: rgba(25, 135, 84, 0.1); color: #198754; }
    .status-shipped { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .status-canceled { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .status-stopped { background: rgba(255, 193, 7, 0.1); color: #ffc107; }

    .workshop-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .workshop-1 { background: rgba(79, 151, 199, 0.15); color: #4F97C7; }
    .workshop-3 { background: rgba(32, 201, 151, 0.15); color: #20c997; }
    .workshop-2 { background: rgba(253, 126, 20, 0.15); color: #fd7e14; }

    .collapse-section {
        transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    .file-upload-area {
        border: 2px dashed rgba(79, 151, 199, 0.3);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: var(--transition-smooth);
        background: rgba(79, 151, 199, 0.05);
    }

    .file-upload-area:hover {
        border-color: rgba(79, 151, 199, 0.6);
        background: rgba(79, 151, 199, 0.08);
    }

    .file-upload-area.dragover {
        border-color: #4F97C7;
        background: rgba(79, 151, 199, 0.12);
        transform: scale(1.02);
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(79, 151, 199, 0.2);
        border-left: 4px solid #4F97C7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        box-shadow: var(--shadow-large);
        padding: 1rem 1.5rem;
        transform: translateX(150%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast.success { border-left: 4px solid #198754; }
    .toast.error { border-left: 4px solid #dc3545; }
    .toast.warning { border-left: 4px solid #ffc107; }
</style>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- Toast Notification -->
<div class="toast hidden" id="toast">
    <div class="toast-content">
        <strong id="toastTitle"></strong>
        <p id="toastMessage" class="mb-0"></p>
    </div>
</div>

<div class="container-fluid my-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title mb-0">Детали заказа: №{{ order.id }}</h1>
                <div class="badge bg-primary fs-6 p-3">Создан: {{ order.created_at|date:"d.m.Y H:i" }}</div>
            </div>
        </div>
    </div>

    <!-- File Upload Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong>Файл заказа</strong>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-3">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        Текущий файл:
                        <a href="{{ order.order_file.url }}" class="btn btn-link text-decoration-none" target="_blank">
                            <i class="bi bi-download me-1"></i>Скачать файл заказа
                        </a>
                    </p>
                </div>
                <div class="col-md-6">
                    <div class="file-upload-area" id="fileUploadArea">
                        <i class="bi bi-cloud-arrow-up fs-1 text-primary mb-3"></i>
                        <h5>Заменить файл заказа</h5>
                        <p class="text-muted">Перетащите файл сюда или нажмите для выбора</p>
                        <form method="post" enctype="multipart/form-data" id="replaceFileForm"
                              action="{% url 'order_upload' order_id=order.pk %}">
                            {% csrf_token %}
                            <input type="file" class="form-control d-none" id="order_file" name="order_file" required>
                            <button type="button" class="btn btn-primary mt-2" onclick="document.getElementById('order_file').click()">
                                <i class="bi bi-folder2-open me-2"></i>Выбрать файл
                            </button>
                            <div class="mt-2" id="fileName"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoices Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Связанные счета</strong>
            <button id="toggleInvoices" class="btn btn-primary btn-sm">
                <i class="bi bi-chevron-down me-1"></i>Развернуть
            </button>
        </div>
        <div id="invoiceItems" class="collapse-section">
            <div class="card-body">
                {% if order.invoice %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-file-earmark-text fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">Счет №{{ order.invoice.number }}</h6>
                                <small class="text-muted">Дата: {{ order.invoice.date }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-building fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-1">{{ order.invoice.organization }}</h6>
                                <small class="text-muted">Организация</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="stat-card info p-3 mb-3">
                            <div class="stat-header">Общая сумма</div>
                            <div class="stat-content">{{ order.invoice.amount|intcomma }} р.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stat-card success p-3 mb-3">
                            <div class="stat-header">Оплаченная сумма</div>
                            <div class="stat-content">{{ order.invoice.payed_amount|intcomma }} р.</div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <a href="{% url 'invoice_detail' order.invoice.id %}" class="btn btn-primary me-2">
                        <i class="bi bi-eye me-1"></i>Детали счета
                    </a>
                    <a href="{% url 'organization_detail' order.invoice.organization.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-building me-1"></i>Профиль организации
                    </a>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-file-earmark-x fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">Отсутствуют связанные счета</h5>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Changes History Card -->
    {% if changes %}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>История изменений</strong>
            <button id="toggleChanges" class="btn btn-primary btn-sm">
                <i class="bi bi-chevron-down me-1"></i>Развернуть
            </button>
        </div>
        <div id="changeItems" class="collapse-section">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 180px;">Дата изменения</th>
                                <th style="width: 200px;">Изменивший</th>
                                <th>Комментарий</th>
                                <th style="width: 120px;">Файл</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for change in changes %}
                            <tr>
                                <td class="text-nowrap">
                                    <i class="bi bi-clock me-1 text-muted"></i>
                                    {{ change.changed_at|date:"d.m.Y H:i" }}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-2" style="width: 32px; height: 32px; font-size: 0.75rem;">
                                            {{ change.changed_by.first_name|first }}{{ change.changed_by.last_name|first }}
                                        </div>
                                        {{ change.changed_by.get_full_name }}
                                    </div>
                                </td>
                                <td>
                                    {% if change.comment %}
                                    <span class="text-break">{{ change.comment|safe }}</span>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if change.order_file %}
                                    <a href="{{ change.order_file.url }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Order Items Card -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Содержимое заказа</strong>
            <div>
                <button id="toggleButton" class="btn btn-primary btn-sm me-2">
                    <i class="bi bi-chevron-down me-1"></i>Развернуть
                </button>
                <button type="button" class="btn btn-success btn-sm" id="editButton">
                    <i class="bi bi-pencil me-1"></i>Редактировать
                </button>
            </div>
        </div>
        <div id="orderItems" class="collapse-section">
            <div class="card-body">
                <div class="table-responsive" style="max-height: 600px;">
                    <table class="table table-hover table-striped">
                        <thead class="sticky-top">
                            <tr>
                                <th style="width: 60px;">№</th>
                                <th style="min-width: 150px;">Наименование</th>
                                <th style="min-width: 120px;">Тип</th>
                                <th style="width: 80px;">Высота</th>
                                <th style="width: 80px;">Ширина</th>
                                <th style="width: 80px;">Откр.</th>
                                <th style="min-width: 120px;">Стекло</th>
                                <th style="min-width: 120px;">Фурнитура</th>
                                <th style="width: 80px;">Кол-во</th>
                                <th style="min-width: 200px;">Комментарий</th>
                                <th style="width: 140px;">Статус</th>
                                <th style="width: 100px;">Цех</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in filtered_items %}
                            <tr>
                                <td class="text-center fw-bold">{{ item.position_num }}</td>
                                <td>{{ item.get_p_kind_display }}</td>
                                <td class="text-nowrap">{{ item.get_p_type_display }}</td>
                                <td class="text-center">{{ item.p_height }}</td>
                                <td class="text-center">{{ item.p_width }}</td>
                                <td class="text-center">{{ item.p_open }}</td>
                                <td>{{ item.d_glass|safe }}</td>
                                <td>{{ item.p_furniture }}</td>
                                <td class="text-center fw-bold">{{ item.p_quantity }}</td>
                                <td>
                                    <span class="text-break">{{ item.p_comment|default_if_none:'' }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="current-status status-badge status-{{ item.p_status }}"
                                          data-id="{{ item.id }}">
                                        {{ item.get_p_status_display }}
                                    </span>
                                    <select class="form-select order-status-select hidden" data-id="{{ item.id }}">
                                        <option value="in_query" {% if item.p_status == 'in_query' %}selected{% endif %}>в очереди</option>
                                        <option value="product" {% if item.p_status == 'product' %}selected{% endif %}>запущен</option>
                                        <option value="ready" {% if item.p_status == 'ready' %}selected{% endif %}>готов</option>
                                        <option value="shipped" {% if item.p_status == 'shipped' %}selected{% endif %}>отгружен</option>
                                        <option value="canceled" {% if item.p_status == 'canceled' %}selected{% endif %}>отменен</option>
                                        <option value="stopped" {% if item.p_status == 'stopped' %}selected{% endif %}>остановлен</option>
                                    </select>
                                </td>
                                <td class="text-center">
                                    <span class="current-workshop workshop-badge workshop-{{ item.workshop }}"
                                          data-id="{{ item.id }}">
                                        {% if item.workshop != 2 %}{{ item.workshop }}{% else %}стоп{% endif %}
                                    </span>
                                    <select class="form-select item-workshop-select hidden" data-id="{{ item.id }}">
                                        <option value="1" {% if item.workshop == 1 %}selected{% endif %}>1</option>
                                        <option value="3" {% if item.workshop == 3 %}selected{% endif %}>3</option>
                                        <option value="2" {% if item.workshop == 2 %}selected{% endif %}>стоп</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class OrderDetailManager {
    constructor() {
        this.csrfToken = '{{ csrf_token }}';
        this.isEditing = false;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupFileUpload();
    }

    setupEventListeners() {
        // Collapse sections
        document.getElementById('toggleInvoices').addEventListener('click', () =>
            this.toggleSection('toggleInvoices', 'invoiceItems'));

        document.getElementById('toggleButton').addEventListener('click', () =>
            this.toggleSection('toggleButton', 'orderItems'));

        if (document.getElementById('toggleChanges')) {
            document.getElementById('toggleChanges').addEventListener('click', () =>
                this.toggleSection('toggleChanges', 'changeItems'));
        }

        // Edit button
        document.getElementById('editButton').addEventListener('click', () =>
            this.toggleEditMode());
    }

    setupFileUpload() {
        const fileInput = document.getElementById('order_file');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileName = document.getElementById('fileName');
        const form = document.getElementById('replaceFileForm');

        if (fileInput && fileUploadArea) {
            // Click on area to trigger file input
            fileUploadArea.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    fileInput.click();
                }
            });

            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, this.preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, () =>
                    fileUploadArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, () =>
                    fileUploadArea.classList.remove('dragover'), false);
            });

            fileUploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    this.handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    this.handleFileSelect(e.target.files[0]);
                }
            });

            form.addEventListener('submit', (e) => this.handleFormSubmit(e));
        }
    }

    handleFileSelect(file) {
        const fileName = document.getElementById('fileName');
        if (fileName) {
            fileName.innerHTML = `
                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    <div>
                        <strong>${file.name}</strong>
                        <div class="text-muted small">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm ms-auto">
                        <i class="bi bi-upload me-1"></i>Загрузить
                    </button>
                </div>
            `;
        }
    }

    async handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        this.showLoading(true);

        try {
            const response = await fetch(e.target.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': this.csrfToken
                }
            });

            if (response.ok) {
                this.showToast('success', 'Файл успешно загружен', 'Новый файл заказа был успешно заменен.');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error('Ошибка при загрузке файла');
            }
        } catch (error) {
            this.showToast('error', 'Ошибка', 'Не удалось загрузить файл. Попробуйте еще раз.');
        } finally {
            this.showLoading(false);
        }
    }

    toggleEditMode() {
        const editButton = document.getElementById('editButton');
        const statusSelects = document.querySelectorAll('.order-status-select');
        const workshopSelects = document.querySelectorAll('.item-workshop-select');

        if (!this.isEditing) {
            // Enter edit mode
            statusSelects.forEach(select => {
                select.classList.remove('hidden');
                select.previousElementSibling.classList.add('hidden');
            });

            workshopSelects.forEach(select => {
                select.classList.remove('hidden');
                select.previousElementSibling.classList.add('hidden');
            });

            editButton.innerHTML = '<i class="bi bi-check-lg me-1"></i>Сохранить';
            editButton.classList.remove('btn-success');
            editButton.classList.add('btn-primary');
            this.isEditing = true;
        } else {
            // Save changes
            this.saveChanges();
        }
    }

    async saveChanges() {
        const updates = {};
        const statusSelects = document.querySelectorAll('.order-status-select');
        const workshopSelects = document.querySelectorAll('.item-workshop-select');

        statusSelects.forEach(select => {
            const id = select.dataset.id;
            updates[id] = updates[id] || {};
            updates[id].status = select.value;
        });

        workshopSelects.forEach(select => {
            const id = select.dataset.id;
            updates[id] = updates[id] || {};
            updates[id].workshop = select.value;
            updates[id].path = 'order_detail';
        });

        this.showLoading(true);

        try {
            const response = await fetch('/erp_main/update-order-item-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.csrfToken
                },
                body: JSON.stringify({ updates: updates })
            });

            if (response.ok) {
                const data = await response.json();

                // Update UI
                Object.keys(data).forEach(id => {
                    const newStatus = data[id].status;
                    const newWorkshop = data[id].workshop;

                    // Update status badge
                    const statusBadge = document.querySelector(`.current-status[data-id="${id}"]`);
                    if (statusBadge) {
                        statusBadge.textContent = this.getStatusDisplay(newStatus);
                        statusBadge.className = `current-status status-badge status-${newStatus}`;
                    }

                    // Update workshop badge
                    const workshopBadge = document.querySelector(`.current-workshop[data-id="${id}"]`);
                    if (workshopBadge) {
                        workshopBadge.textContent = newWorkshop === '2' ? 'стоп' : newWorkshop;
                        workshopBadge.className = `current-workshop workshop-badge workshop-${newWorkshop}`;
                    }
                });

                // Exit edit mode
                this.exitEditMode();
                this.showToast('success', 'Изменения сохранены', 'Статусы и цеха успешно обновлены.');
            } else {
                throw new Error('Ошибка при сохранении изменений');
            }
        } catch (error) {
            this.showToast('error', 'Ошибка', 'Не удалось сохранить изменения. Попробуйте еще раз.');
        } finally {
            this.showLoading(false);
        }
    }

    exitEditMode() {
        const editButton = document.getElementById('editButton');
        const statusSelects = document.querySelectorAll('.order-status-select');
        const workshopSelects = document.querySelectorAll('.item-workshop-select');

        statusSelects.forEach(select => {
            select.classList.add('hidden');
            select.previousElementSibling.classList.remove('hidden');
        });

        workshopSelects.forEach(select => {
            select.classList.add('hidden');
            select.previousElementSibling.classList.remove('hidden');
        });

        editButton.innerHTML = '<i class="bi bi-pencil me-1"></i>Редактировать';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
        this.isEditing = false;
    }

    getStatusDisplay(status) {
        const statusMap = {
            'in_query': 'в очереди',
            'product': 'запущен',
            'ready': 'готов',
            'shipped': 'отгружен',
            'canceled': 'отменен',
            'stopped': 'остановлен'
        };
        return statusMap[status] || status;
    }

    toggleSection(buttonId, sectionId) {
        const button = document.getElementById(buttonId);
        const section = document.getElementById(sectionId);
        const icon = button.querySelector('i');
        const isExpanded = section.style.maxHeight && section.style.maxHeight !== '0px';

        if (isExpanded) {
            section.style.maxHeight = '0px';
            button.innerHTML = '<i class="bi bi-chevron-down me-1"></i>Развернуть';
        } else {
            section.style.maxHeight = section.scrollHeight + 'px';
            button.innerHTML = '<i class="bi bi-chevron-up me-1"></i>Скрыть';
        }
    }

    showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = show ? 'flex' : 'none';
        }
    }

    showToast(type, title, message) {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        toast.className = `toast ${type}`;
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.classList.add('hidden'), 400);
        }, 3000);
    }

    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new OrderDetailManager();
});
</script>

{% endblock %}