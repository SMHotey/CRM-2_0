{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid my-4">
    <h1 class="mb-4 text-center">Детали заказа: №{{ order.id }}</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong>Информация о заказе</strong>
        </div>
        <div class="card-body">
            <h5 class="card-title">Дата создания: {{ order.created_at }}</h5>
            <p class="card-text">Файл заказа: <a class="btn btn-link" href="{{ order.order_file.url }}">Скачать</a></p>
            <form method="post" enctype="multipart/form-data" class="mt-3" id="replaceFileForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="order_file" class="form-label">Заменить файл заказа:</label>
                    <input type="file" class="form-control" id="order_file" name="order_file" required>
                </div>
                <button type="submit" class="btn btn-primary">Загрузить новый файл заказа</button>
            </form>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Связанные счета</strong>
            <button id="toggleInvoices" class="btn btn-primary">Развернуть</button>
        </div>
        <div id="invoiceItems" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease;">
            <div class="card-body">
                <ul class="list-group">
                    {% if order.invoice %}
                        <li class="list-group-item">Счет №: <a href="{% url 'invoice_detail' order.invoice.id %}">{{ order.invoice.number }}</a></li>
                        <li class="list-group-item">Организация: <a href="{% url 'organization_detail' order.invoice.organization.id %}">{{ order.invoice.organization }}</a></li>
                        <li class="list-group-item">Дата: {{ order.invoice.date }}</li>
                        <li class="list-group-item">Сумма: {{ order.invoice.amount|intcomma }} р.</li>
                        <li class="list-group-item">Оплаченная сумма: {{ order.invoice.payed_amount|intcomma }} р.</li>
                    {% else %}
                        <li class="list-group-item">Отсутствуют связанные счета.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Содержимое заказа</strong>
            <button id="toggleButton" class="btn btn-primary">Развернуть</button>
        </div>
<div id="orderItems" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease;">
    <div class="card-body">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th style="text-align: center; vertical-align: middle;">№</th>
                    <th style="text-align: center; vertical-align: middle;">Наименование</th>
                    <th style="text-align: center; vertical-align: middle;">Тип</th>
                    <th style="text-align: center; vertical-align: middle;">Ширина</th>
                    <th style="text-align: center; vertical-align: middle;">Высота</th>
                    <th style="text-align: center; vertical-align: middle;">Откр.</th>
                    <th style="text-align: center; vertical-align: middle; width: 120px">Стекло</th>
                    <th style="text-align: center; vertical-align: middle;">Кол-во</th>
                    <th style="text-align: center; vertical-align: middle;">Комментарий</th>
                    <th style="text-align: center; vertical-align: middle;">Статус</th>
                </tr>
            </thead>
            <tbody>
                {% for item in filtered_items %}
                <tr>

                    <td style="text-align: center; vertical-align: middle;">{{ item.position_num }}</td>
                    <td style="text-align: center; vertical-align: middle;">{{ item.get_p_kind_display }}</td>
                    <td style="text-align: center; vertical-align: middle; white-space: nowrap;">{{ item.get_p_type_display }}</td>
                    <td style="text-align: center; vertical-align: middle;">{{ item.p_width }}</td>
                    <td style="text-align: center; vertical-align: middle;">{{ item.p_height }}</td>
                    <td style="text-align: center; vertical-align: middle;">{{ item.p_open }}</td>
                    <td style="text-align: center; vertical-align: middle;">{{ item.d_glass|safe }}</td>
                    <td style="text-align: center; vertical-align: middle;">{{ item.p_quantity }}</td>
                    {% if item.p_comment %}
                        <td style="text-align: left; vertical-align: middle;">{{ item.p_comment }}</td>
                    {% else %}
                        <td style="text-align: left; vertical-align: middle;"></td>
                    {% endif %}
                    <td style="width:200px; text-align: center; vertical-align: middle;">
                        <select class="form-select order-status-select" data-id="{{ item.id }}">
                            <option value="in_query" {% if item.p_status == 'in_query' %} selected {% endif %}>в очереди</option>
                            <option value="product" {% if item.p_status == 'product' %} selected {% endif %}>запущен</option>
                            <option value="ready" {% if item.p_status == 'ready' %} selected {% endif %}>готов</option>
                            <option value="shipped" {% if item.p_status == 'shipped' %} selected {% endif %}>отгружен</option>
                            <option value="canceled" {% if item.p_status == 'canceled' %} selected {% endif %}>отменен</option>
                            <option value="stopped" {% if item.p_status == 'stopped' %} selected {% endif %}>остановлен</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" class="btn btn-primary" id="saveStatusChangesButton" style="margin: 15px;">Сохранить изменения</button>
    </div>
</div>
    </div>
</div>

<script>
const saveStatusChangesButton = document.getElementById('saveStatusChangesButton');
const csrfToken = '{{ csrf_token }}';

saveStatusChangesButton.onclick = function() {
    const statusUpdates = {};
    const selectElements = document.querySelectorAll('.order-status-select');

    selectElements.forEach(select => {
        const id = select.getAttribute('data-id');
        const newStatus = select.value;
        statusUpdates[id] = newStatus;

        // Обновление текста выбора статуса
        const statusTextElement = select.previousElementSibling; // Предполагаем, что перед select есть элемент
        if (statusTextElement) {
            statusTextElement.innerText = newStatus; // Обновляем текст
        }
    });

    fetch(`/erp_main/update-order-item-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({'status_updates': statusUpdates})
    })
    .then(response => {
        if (response.ok) {
            alert('Статусы успешно обновлены!');
        } else {
            alert('Ошибка обновления статусов!');
        }
    });
};

document.getElementById("toggleInvoices").addEventListener("click", function() {
    toggleSection("toggleInvoices", "invoiceItems");
});

document.getElementById("toggleButton").addEventListener("click", function() {
    toggleSection("toggleButton", "orderItems");
});

function toggleSection(buttonId, sectionId) {
    const button = document.getElementById(buttonId);
    const section = document.getElementById(sectionId);
    const isExpanded = section.style.maxHeight !== "0px";

    section.style.maxHeight = isExpanded ? "0px" : section.scrollHeight + "px";
    button.textContent = isExpanded ? "Развернуть" : "Скрыть";
}
</script>

{% endblock %}

