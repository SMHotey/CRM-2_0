{% extends 'base.html' %}

{% block page_title %}Расчет стоимости{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="card">
        <div class="card-header">
            <h4>Калькулятор стоимости</h4>
        </div>
        <div class="card-body">
            <!-- Основные кнопки действий -->
            <div class="d-flex flex-wrap gap-2 mb-3">
                <button id="calculate-btn" class="btn btn-primary">Рассчитать</button>
                <button id="add-row" class="btn btn-success">+ Добавить строку</button>
                <button id="save-btn" class="btn btn-info">Сохранить данные</button>
            </div>

            <!-- Блок элементов управления таблицей -->
            <div class="table-controls-panel card mb-3">
                <div class="card-header py-2">
                    <h6 class="mb-0">Управление таблицей</h6>
                </div>
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <button id="toggle-size-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrows-expand"></i> Скрыть размеры
                        </button>
                        <button id="toggle-transom-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-layout-three-columns"></i> Фрамуга
                        </button>
                        <button id="toggle-glazing1-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-grid-3x3"></i> Остекление 1
                        </button>
                        <button id="toggle-glazing2-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-grid-3x3"></i> Остекление 2
                        </button>
                        <button id="toggle-metal-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-shield"></i> Металл
                        </button>
                        <button id="toggle-vent-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-grid"></i> Вентрешетка
                        </button>
                        <button id="toggle-bumper-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-border-all"></i> Отбойная пластина
                        </button>
                        <button id="toggle-extension-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrows-expand-vertical"></i> Добор
                        </button>
                        <button id="toggle-color-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-palette"></i> Цвет
                        </button>
                        <button id="toggle-hardware1-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-gear"></i> Скрыть фурнитуру 1
                        </button>
                        <button id="toggle-hardware2-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-gear"></i> Фурнитура 2
                        </button>
                        <button id="toggle-closer-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left-right"></i> Доводчик
                        </button>
                        <button id="toggle-cylinder-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-key"></i> Цилиндр
                        </button>
                        <button id="toggle-autothreshold-btn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-border-bottom"></i> Авт.порог
                        </button>
                    </div>
                </div>
            </div>

            <div id="save-status" class="mt-2"></div>
            <div id="calculation-table" style="height: 500px;"></div>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения информации о строке -->
<div class="modal fade" id="rowInfoModal" tabindex="-1" aria-labelledby="rowInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rowInfoModalLabel">Информация о строке #<span id="modal-row-id"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Поле</th>
                                <th>Значение</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Изделие</strong></td>
                                <td id="modal-product"></td>
                            </tr>
                            <tr>
                                <td><strong>Тип</strong></td>
                                <td id="modal-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Ширина</strong></td>
                                <td id="modal-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Высота</strong></td>
                                <td id="modal-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Фрамуга высота</strong></td>
                                <td id="modal-transom-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Фрамуга ширина</strong></td>
                                <td id="modal-transom-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Фрамуга остекление</strong></td>
                                <td id="modal-transom-glazing"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 1 вид</strong></td>
                                <td id="modal-glazing1-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 1 высота</strong></td>
                                <td id="modal-glazing1-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 1 ширина</strong></td>
                                <td id="modal-glazing1-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 2 вид</strong></td>
                                <td id="modal-glazing2-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 2 высота</strong></td>
                                <td id="modal-glazing2-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 2 ширина</strong></td>
                                <td id="modal-glazing2-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Металл</strong></td>
                                <td id="modal-metal"></td>
                            </tr>
                            <tr>
                                <td><strong>Вентрешетка вид</strong></td>
                                <td id="modal-vent-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Вентрешетка высота</strong></td>
                                <td id="modal-vent-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Вентрешетка ширина</strong></td>
                                <td id="modal-vent-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Отбойная пластина высота</strong></td>
                                <td id="modal-bumper-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Отбойная пластина с 2-х сторон</strong></td>
                                <td id="modal-bumper-both-sides"></td>
                            </tr>
                            <tr>
                                <td><strong>Добор (толщина стены)</strong></td>
                                <td id="modal-extension"></td>
                            </tr>
                            <tr>
                                <td><strong>RALвнеш</strong></td>
                                <td id="modal-ral-external"></td>
                            </tr>
                            <tr>
                                <td><strong>RALвнутр</strong></td>
                                <td id="modal-ral-internal"></td>
                            </tr>
                            <tr>
                                <td><strong>муар</strong></td>
                                <td id="modal-moire"></td>
                            </tr>
                            <tr>
                                <td><strong>лак</strong></td>
                                <td id="modal-varnish"></td>
                            </tr>
                            <tr>
                                <td><strong>грунт</strong></td>
                                <td id="modal-primer"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 1 ручка</strong></td>
                                <td id="modal-hardware1-handle"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 1 замок</strong></td>
                                <td id="modal-hardware1-lock"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 2 ручка</strong></td>
                                <td id="modal-hardware2-handle"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 2 замок</strong></td>
                                <td id="modal-hardware2-lock"></td>
                            </tr>
                            <tr>
                                <td><strong>Доводчик</strong></td>
                                <td id="modal-closer"></td>
                            </tr>
                            <tr>
                                <td><strong>Цилиндр</strong></td>
                                <td id="modal-cylinder"></td>
                            </tr>
                            <tr>
                                <td><strong>Авт.порог</strong></td>
                                <td id="modal-auto-threshold"></td>
                            </tr>
                            <tr>
                                <td><strong>Количество</strong></td>
                                <td id="modal-quantity"></td>
                            </tr>
                            <tr>
                                <td><strong>Сумма</strong></td>
                                <td id="modal-total"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Контекстное меню для строк -->
<div id="rowContextMenu" class="dropdown-menu">
    <button class="dropdown-item" type="button" data-action="add-above">Добавить строку сверху</button>
    <button class="dropdown-item" type="button" data-action="add-below">Добавить строку снизу</button>
    <button class="dropdown-item" type="button" data-action="delete">Удалить строку</button>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Tabulator === 'undefined') {
        console.error('Tabulator не загружен!');
        document.getElementById('save-status').innerHTML = `
            <div class="alert alert-danger">
                Ошибка загрузки Tabulator. Пожалуйста, обновите страницу.
            </div>
        `;
        return;
    }

    // Данные для выпадающих списков (должны быть переданы из представления)
    const dropdownData = {{ dropdown_data|safe }};

    // Инициализация модального окна Bootstrap
    const rowInfoModal = new bootstrap.Modal(document.getElementById('rowInfoModal'));

    const customSelectEditor = function(cell, onRendered, success, cancel, editorParams) {
        const input = document.createElement("select");

        for (const [value, label] of Object.entries(editorParams.values)) {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = label;
            if (value === cell.getValue()) option.selected = true;
            input.appendChild(option);
        }

        input.addEventListener("change", function() {
            success(input.value);
        });

        input.addEventListener("blur", function() {
            cancel();
        });

        onRendered(function() {
            input.focus();
        });

        return input;
    };

    const table = new Tabulator("#calculation-table", {
        data: [
            {
                id: 1,
                door_type: "Дверь",
                price: 15000,
                quantity: 1,
                door_kind: "EI-60",
                width: 900,
                height: 2100,
                transom_height: 0,
                transom_width: 0,
                transom_glazing: "none",
                glazing1_type: "none",
                glazing1_height: 0,
                glazing1_width: 0,
                glazing2_type: "none",
                glazing2_height: 0,
                glazing2_width: 0,
                metal: "1.2-1.4",
                vent_type: "none",
                vent_height: 0,
                vent_width: 0,
                bumper_height: 0,
                bumper_both_sides: "no",
                extension: 0,
                ral_external: "9001",
                ral_internal: "9002",
                moire: "no",
                varnish: "yes",
                primer: "yes",
                hardware1_handle: "",
                hardware1_lock: "",
                hardware2_handle: "",
                hardware2_lock: "",
                closer: "",
                cylinder: "",
                auto_threshold: "no"
            },
            {
                id: 2,
                door_type: "Дверь 2-ств.",
                price: 8000,
                quantity: 2,
                door_kind: "EIS-60",
                width: 800,
                height: 2000,
                transom_height: 400,
                transom_width: 800,
                transom_glazing: "single",
                glazing1_type: "single",
                glazing1_height: 300,
                glazing1_width: 200,
                glazing2_type: "none",
                glazing2_height: 0,
                glazing2_width: 0,
                metal: "1.4-1.4",
                vent_type: "tech",
                vent_height: 100,
                vent_width: 200,
                bumper_height: 150,
                bumper_both_sides: "yes",
                extension: 120,
                ral_external: "9010",
                ral_internal: "9010",
                moire: "yes",
                varnish: "no",
                primer: "yes",
                hardware1_handle: "handle_type1",
                hardware1_lock: "lock_type1",
                hardware2_handle: "",
                hardware2_lock: "",
                closer: "closer_type1",
                cylinder: "cylinder_type1",
                auto_threshold: "yes"
            },
        ],
        columns: [
            {
                title: "№",
                field: "id",
                width: 40,
                frozen: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    // Открываем модальное окно при клике на ячейку с номером
                    showRowInfo(cell.getRow());
                }
            },
            {
                title: "Изделие",
                width: 100,
                field: "door_type",
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.door_types || {
                        "door": "Дверь",
                        "door_2": "Дверь 2-ств.",
                        "hatch": "Люк",
                        "gate": "Ворота"
                    }
                },
                formatter: function(cell) {
                    const map = dropdownData.door_types || {
                        "door": "Дверь",
                        "door_2": "Дверь 2-ств.",
                        "hatch": "Люк",
                        "gate": "Ворота"
                    };
                    const value = cell.getValue();
                    return map[value] || value;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Тип",
                field: "door_kind",
                width: 60,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.door_kinds || {
                        "tech": "тех.",
                        "ei-60": "EI-60",
                        "eis-60": "EIS-60",
                        "revision": "однолист."
                    }
                },
                formatter: function(cell) {
                    const map = dropdownData.door_kinds || {
                        "tech": "тех.",
                        "ei-60": "EI-60",
                        "eis-60": "EIS-60",
                        "revision": "однолист."
                    };
                    const value = cell.getValue();
                    return map[value] || value;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Размеры по коробке",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Высота",
                        width: 90,
                        field: "height",
                        visible: true,
                        editor: "number",
                        validator: ["required", "numeric", "min:100", "max:3000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "width",
                        visible: true,
                        editor: "number",
                        validator: ["required", "numeric", "min:100", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                ]
            },
            {
                title: "Фрамуга",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Высота",
                        width: 90,
                        field: "transom_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:1000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "transom_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Вид остекления",
                        width: 110,
                        field: "transom_glazing",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Остекление_1",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Вид",
                        width: 100,
                        field: "glazing1_type",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "Высота",
                        width: 90,
                        field: "glazing1_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:1000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "glazing1_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Опции",
                        width: 100,
                        field: "glazing1_options",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_options || {
                                "option1": "Опция 1",
                                "option2": "Опция 2",
                                "option3": "Опция 3"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_options || {
                                "option1": "Опция 1",
                                "option2": "Опция 2",
                                "option3": "Опция 3"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Остекление_2",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Вид",
                        width: 100,
                        field: "glazing2_type",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "Высота",
                        width: 90,
                        field: "glazing2_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:1000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "glazing2_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Опции",
                        width: 100,
                        field: "glazing2_options",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_options || {
                                "option1": "Опция 1",
                                "option2": "Опция 2",
                                "option3": "Опция 3"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_options || {
                                "option1": "Опция 1",
                                "option2": "Опция 2",
                                "option3": "Опция 3"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Металл",
                width: 100,
                field: "metal",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.metal_types || {
                        "1.2-1.4": "1.2-1.4",
                        "1.4-1.4": "1.4-1.4",
                        "1.4-2.0": "1.4-2.0"
                    }
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Вентрешетка",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Вид",
                        width: 80,
                        field: "vent_type",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.vent_types || {
                                "none": "нет",
                                "tech": "тех.",
                                "semi-prof": "п/п"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.vent_types || {
                                "none": "нет",
                                "tech": "тех.",
                                "semi-prof": "п/п"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "Высота",
                        width: 90,
                        field: "vent_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:500"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "vent_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:500"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    }
                ]
            },
            {
                title: "Отбойная пластина",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Высота",
                        width: 90,
                        field: "bumper_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:300"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? value + " мм" : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "С 2-х сторон",
                        width: 110,
                        field: "bumper_both_sides",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "no": "нет",
                                "yes": "да"
                            }
                        },
                        formatter: function(cell) {
                            const map = {
                                "no": "нет",
                                "yes": "да"
                            };
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Добор",
                width: 100,
                field: "extension",
                visible: false,
                editor: "number",
                validator: ["numeric", "min:0", "max:500"],
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? value + " мм" : "—";
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Цвет",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "RAL внеш",
                        width: 80,
                        field: "ral_external",
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.ral_colors || {}
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "RAL внутр",
                        width: 80,
                        field: "ral_internal",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.ral_colors || {}
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "муар",
                        width: 60,
                        field: "moire",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "yes": "да",
                                "no": "нет"
                            }
                        },
                        formatter: function(cell) {
                            const map = {"yes": "да", "no": "нет"};
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "лак",
                        width: 60,
                        field: "varnish",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "yes": "да",
                                "no": "нет"
                            }
                        },
                        formatter: function(cell) {
                            const map = {"yes": "да", "no": "нет"};
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "грунт",
                        width: 60,
                        field: "primer",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "yes": "да",
                                "no": "нет"
                            }
                        },
                        formatter: function(cell) {
                            const map = {"yes": "да", "no": "нет"};
                            const value = cell.getValue();
                            return map[value] || value;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Фурнитура_1",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "ручка",
                        width: 100,
                        field: "hardware1_handle",
                        visible: true,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_handles || {}
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "замок",
                        width: 100,
                        field: "hardware1_lock",
                        visible: true,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_locks || {}
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Фурнитура_2",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "ручка",
                        width: 100,
                        field: "hardware2_handle",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_handles || {}
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "замок",
                        width: 100,
                        field: "hardware2_lock",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_locks || {}
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Доводчик",
                width: 100,
                field: "closer",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.closers || {}
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Цилиндр",
                width: 100,
                field: "cylinder",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.cylinders || {}
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Авт.порог",
                width: 90,
                field: "auto_threshold",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: {
                        "yes": "да",
                        "no": "нет"
                    }
                },
                formatter: function(cell) {
                    const map = {"yes": "да", "no": "нет"};
                    const value = cell.getValue();
                    return map[value] || value;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Кол-во",
                field: "quantity",
                editor: "number",
                validator: ["required", "integer", "min:1"],
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center"
            },
            {
                title: "Сумма (₽)",
                field: "total",
                formatter: "money",
                formatterParams: {symbol: "₽", precision: 0},
                bottomCalc: "sum",
                bottomCalcParams: {precision: 0},
                mutator: function(value, data) {
                    const price = parseFloat(data.price) || 0;
                    const quantity = parseInt(data.quantity) || 0;
                    return price * quantity;
                },
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center"
            }
        ],
        layout: "fitColumns",
        cellEdited: function(cell) {
            const fieldsToRecalc = ["price", "quantity", "width", "height", "transom_height", "transom_width",
                                  "glazing1_height", "glazing1_width", "glazing2_height", "glazing2_width",
                                  "vent_height", "vent_width", "bumper_height", "extension"];
            if (fieldsToRecalc.includes(cell.getField())) {
                const row = cell.getRow();
                row.recalc();
                table.recalc();
            }
        }
    });

    // Обработчик контекстного меню для строк
    let contextMenuRow = null;

    table.on("rowContext", function(e, row) {
        e.preventDefault();
        contextMenuRow = row;

        // Позиционируем контекстное меню
        const menu = document.getElementById("rowContextMenu");
        menu.style.display = "block";
        menu.style.position = "absolute";
        menu.style.left = e.pageX + "px";
        menu.style.top = e.pageY + "px";
    });

    // Закрытие контекстного меню при клике вне его
    document.addEventListener("click", function(e) {
        const menu = document.getElementById("rowContextMenu");
        if (menu.style.display === "block" && !menu.contains(e.target)) {
            menu.style.display = "none";
        }
    });

    // Обработка действий контекстного меню
    document.querySelectorAll("#rowContextMenu .dropdown-item").forEach(item => {
        item.addEventListener("click", function() {
            const action = this.getAttribute("data-action");
            const menu = document.getElementById("rowContextMenu");
            menu.style.display = "none";

            if (!contextMenuRow) return;

            const rowData = contextMenuRow.getData();
            const rowIndex = table.getRows().indexOf(contextMenuRow);

            switch(action) {
                case "add-above":
                    addRow(rowIndex);
                    break;
                case "add-below":
                    addRow(rowIndex + 1);
                    break;
                case "delete":
                    contextMenuRow.delete();
                    break;
            }

            contextMenuRow = null;
        });
    });

    // Функция добавления строки
    function addRow(index) {
        const newId = table.getData().length + 1;
        const newRow = {
            id: newId,
            door_type: "door",
            price: 0,
            quantity: 1,
            door_kind: "tech",
            width: 800,
            height: 2000,
            transom_height: 0,
            transom_width: 0,
            transom_glazing: "none",
            glazing1_type: "none",
            glazing1_height: 0,
            glazing1_width: 0,
            glazing1_options: "",
            glazing2_type: "none",
            glazing2_height: 0,
            glazing2_width: 0,
            glazing2_options: "",
            metal: "1.2-1.4",
            vent_type: "none",
            vent_height: 0,
            vent_width: 0,
            bumper_height: 0,
            bumper_both_sides: "no",
            extension: 0,
            ral_external: "",
            ral_internal: "",
            moire: "no",
            varnish: "no",
            primer: "no",
            hardware1_handle: "",
            hardware1_lock: "",
            hardware2_handle: "",
            hardware2_lock: "",
            closer: "",
            cylinder: "",
            auto_threshold: "no"
        };

        table.addRow(newRow, false, index);
    }

    // Функция для отображения информации о строке в модальном окне
    function showRowInfo(row) {
        const data = row.getData();

        // Заполняем модальное окно данными
        document.getElementById('modal-row-id').textContent = data.id;
        document.getElementById('modal-product').textContent = data.door_type ?
            ((dropdownData.door_types || {})[data.door_type] || data.door_type) : "—";

        document.getElementById('modal-type').textContent = data.door_kind ?
            ((dropdownData.door_kinds || {})[data.door_kind] || data.door_kind) : "—";

        document.getElementById('modal-width').textContent = data.width ? data.width + " мм" : "—";
        document.getElementById('modal-height').textContent = data.height ? data.height + " мм" : "—";
        document.getElementById('modal-transom-height').textContent = data.transom_height ? data.transom_height + " мм" : "—";
        document.getElementById('modal-transom-width').textContent = data.transom_width ? data.transom_width + " мм" : "—";

        document.getElementById('modal-transom-glazing').textContent = data.transom_glazing ?
            ((dropdownData.glazing_types || {})[data.transom_glazing] || data.transom_glazing) : "—";

        document.getElementById('modal-glazing1-type').textContent = data.glazing1_type ?
            ((dropdownData.glazing_types || {})[data.glazing1_type] || data.glazing1_type) : "—";
        document.getElementById('modal-glazing1-height').textContent = data.glazing1_height ? data.glazing1_height + " мм" : "—";
        document.getElementById('modal-glazing1-width').textContent = data.glazing1_width ? data.glazing1_width + " мм" : "—";

        document.getElementById('modal-glazing2-type').textContent = data.glazing2_type ?
            ((dropdownData.glazing_types || {})[data.glazing2_type] || data.glazing2_type) : "—";
        document.getElementById('modal-glazing2-height').textContent = data.glazing2_height ? data.glazing2_height + " мм" : "—";
        document.getElementById('modal-glazing2-width').textContent = data.glazing2_width ? data.glazing2_width + " мм" : "—";

        document.getElementById('modal-metal').textContent = data.metal ?
            ((dropdownData.metal_types || {})[data.metal] || data.metal) : "—";

        document.getElementById('modal-vent-type').textContent = data.vent_type ?
            ((dropdownData.vent_types || {})[data.vent_type] || data.vent_type) : "—";
        document.getElementById('modal-vent-height').textContent = data.vent_height ? data.vent_height + " мм" : "—";
        document.getElementById('modal-vent-width').textContent = data.vent_width ? data.vent_width + " мм" : "—";

        document.getElementById('modal-bumper-height').textContent = data.bumper_height ? data.bumper_height + " мм" : "—";
        document.getElementById('modal-bumper-both-sides').textContent = data.bumper_both_sides ?
            ({"no": "нет", "yes": "да"}[data.bumper_both_sides] || data.bumper_both_sides) : "—";

        document.getElementById('modal-extension').textContent = data.extension ? data.extension + " мм" : "—";

        document.getElementById('modal-ral-external').textContent = data.ral_external ?
            ((dropdownData.ral_colors || {})[data.ral_external] || data.ral_external) : "—";
        document.getElementById('modal-ral-internal').textContent = data.ral_internal ?
            ((dropdownData.ral_colors || {})[data.ral_internal] || data.ral_internal) : "—";
        document.getElementById('modal-moire').textContent = data.moire ?
            ({"yes": "да", "no": "нет"}[data.moire] || data.moire) : "—";
        document.getElementById('modal-varnish').textContent = data.varnish ?
            ({"yes": "да", "no": "нет"}[data.varnish] || data.varnish) : "—";
        document.getElementById('modal-primer').textContent = data.primer ?
            ({"yes": "да", "no": "нет"}[data.primer] || data.primer) : "—";

        document.getElementById('modal-hardware1-handle').textContent = data.hardware1_handle ?
            ((dropdownData.hardware_handles || {})[data.hardware1_handle] || data.hardware1_handle) : "—";
        document.getElementById('modal-hardware1-lock').textContent = data.hardware1_lock ?
            ((dropdownData.hardware_locks || {})[data.hardware1_lock] || data.hardware1_lock) : "—";
        document.getElementById('modal-hardware2-handle').textContent = data.hardware2_handle ?
            ((dropdownData.hardware_handles || {})[data.hardware2_handle] || data.hardware2_handle) : "—";
        document.getElementById('modal-hardware2-lock').textContent = data.hardware2_lock ?
            ((dropdownData.hardware_locks || {})[data.hardware2_lock] || data.hardware2_lock) : "—";
        document.getElementById('modal-closer').textContent = data.closer ?
            ((dropdownData.closers || {})[data.closer] || data.closer) : "—";
        document.getElementById('modal-cylinder').textContent = data.cylinder ?
            ((dropdownData.cylinders || {})[data.cylinder] || data.cylinder) : "—";
        document.getElementById('modal-auto-threshold').textContent = data.auto_threshold ?
            ({"yes": "да", "no": "нет"}[data.auto_threshold] || data.auto_threshold) : "—";

        document.getElementById('modal-quantity').textContent = data.quantity || "—";

        // Рассчитываем сумму
        const total = (parseFloat(data.price) || 0) * (parseInt(data.quantity) || 0);
        document.getElementById('modal-total').textContent = total.toLocaleString('ru-RU') + " ₽";

        // Показываем модальное окно
        rowInfoModal.show();
    }

    // Функция для переключения видимости группы столбцов
    function toggleColumnGroup(buttonId, buttonTextShow, buttonTextHide) {
        document.getElementById(buttonId).addEventListener("click", function() {
            const button = this;
            let columns = [];

            // Всегда заново находим столбцы по их field names
            switch(buttonId) {
                case "toggle-size-btn":
                    columns = [table.getColumn("width"), table.getColumn("height")];
                    break;
                case "toggle-transom-btn":
                    columns = [table.getColumn("transom_height"), table.getColumn("transom_width"), table.getColumn("transom_glazing")];
                    break;
                case "toggle-glazing1-btn":
                    columns = [table.getColumn("glazing1_type"), table.getColumn("glazing1_height"), table.getColumn("glazing1_width"), table.getColumn("glazing1_options")];
                    break;
                case "toggle-glazing2-btn":
                    columns = [table.getColumn("glazing2_type"), table.getColumn("glazing2_height"), table.getColumn("glazing2_width"), table.getColumn("glazing2_options")];
                    break;
                case "toggle-metal-btn":
                    columns = [table.getColumn("metal")];
                    break;
                case "toggle-vent-btn":
                    columns = [table.getColumn("vent_type"), table.getColumn("vent_height"), table.getColumn("vent_width")];
                    break;
                case "toggle-bumper-btn":
                    columns = [table.getColumn("bumper_height"), table.getColumn("bumper_both_sides")];
                    break;
                case "toggle-extension-btn":
                    columns = [table.getColumn("extension")];
                    break;
                case "toggle-color-btn":
                    columns = [
                        table.getColumn("ral_external"),
                        table.getColumn("ral_internal"),
                        table.getColumn("moire"),
                        table.getColumn("varnish"),
                        table.getColumn("primer")
                    ];
                    break;
                case "toggle-hardware1-btn":
                    columns = [table.getColumn("hardware1_handle"), table.getColumn("hardware1_lock")];
                    break;
                case "toggle-hardware2-btn":
                    columns = [table.getColumn("hardware2_handle"), table.getColumn("hardware2_lock")];
                    break;
                case "toggle-closer-btn":
                    columns = [table.getColumn("closer")];
                    break;
                case "toggle-cylinder-btn":
                    columns = [table.getColumn("cylinder")];
                    break;
                case "toggle-autothreshold-btn":
                    columns = [table.getColumn("auto_threshold")];
                    break;
            }

            // Проверяем текущее состояние видимости первого столбца (кроме RALвнеш, который всегда видим)
            let currentVisible;
            if (buttonId === "toggle-color-btn") {
                // Для группы цвета проверяем второй столбец (RALвнутр), так как RALвнеш всегда видим
                currentVisible = columns[1] && columns[1].isVisible();
            } else {
                currentVisible = columns[0] && columns[0].isVisible();
            }

            const newVisible = !currentVisible;

            // Переключаем видимость всех столбцов в группе (кроме RALвнеш)
            columns.forEach((column, index) => {
                if (column && !(buttonId === "toggle-color-btn" && index === 0)) {
                    column.toggle(newVisible);
                }
            });

            // Обновляем текст и иконку кнопки
            if (newVisible) {
                button.innerHTML = buttonTextHide;
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-secondary');
            } else {
                button.innerHTML = buttonTextShow;
                button.classList.remove('btn-secondary');
                button.classList.add('btn-outline-secondary');
            }

            table.redraw(true);
        });
    }

    // Инициализация обработчиков для всех кнопки
    toggleColumnGroup("toggle-size-btn",
        '<i class="bi bi-arrows-expand"></i> Размеры',
        '<i class="bi bi-arrows-collapse"></i> Скрыть размеры');

    toggleColumnGroup("toggle-transom-btn",
        '<i class="bi bi-layout-three-columns"></i> Фрамуга',
        '<i class="bi bi-layout-three-columns"></i> Скрыть фрамугу');

    toggleColumnGroup("toggle-glazing1-btn",
        '<i class="bi bi-grid-3x3"></i> Остекление 1',
        '<i class="bi bi-grid-3x3"></i> Скрыть остекление 1');

    toggleColumnGroup("toggle-glazing2-btn",
        '<i class="bi bi-grid-3x3"></i> Остекление 2',
        '<i class="bi bi-grid-3x3"></i> Скрыть остекление 2');

    toggleColumnGroup("toggle-metal-btn",
        '<i class="bi bi-shield"></i> Металл',
        '<i class="bi bi-shield"></i> Скрыть металл');

    toggleColumnGroup("toggle-vent-btn",
        '<i class="bi bi-grid"></i> Вентрешетка',
        '<i class="bi bi-grid"></i> Скрыть вентрешетку');

    toggleColumnGroup("toggle-bumper-btn",
        '<i class="bi bi-border-all"></i> Отбойная пластина',
        '<i class="bi bi-border-all"></i> Скрыть отбойную пластину');

    toggleColumnGroup("toggle-extension-btn",
        '<i class="bi bi-arrows-expand-vertical"></i> Добор',
        '<i class="bi bi-arrows-expand-vertical"></i> Скрыть добор');

    toggleColumnGroup("toggle-color-btn",
        '<i class="bi bi-palette"></i> Цвет',
        '<i class="bi bi-palette"></i> Скрыть цвет');

    toggleColumnGroup("toggle-hardware1-btn",
        '<i class="bi bi-gear"></i> Фурнитура 1',
        '<i class="bi bi-gear"></i> Скрыть фурнитуру 1');

    toggleColumnGroup("toggle-hardware2-btn",
        '<i class="bi bi-gear"></i> Фурнитура 2',
        '<i class="bi bi-gear"></i> Скрыть фурнитуру 2');

    toggleColumnGroup("toggle-closer-btn",
        '<i class="bi bi-arrow-left-right"></i> Доводчик',
        '<i class="bi bi-arrow-left-right"></i> Скрыть доводчик');

    toggleColumnGroup("toggle-cylinder-btn",
        '<i class="bi bi-key"></i> Цилиндр',
        '<i class="bi bi-key"></i> Скрыть цилиндр');

    toggleColumnGroup("toggle-autothreshold-btn",
        '<i class="bi bi-border-bottom"></i> Авт.порог',
        '<i class="bi bi-border-bottom"></i> Скрыть авт.порог');

// Функция расчета
    document.getElementById("calculate-btn").addEventListener("click", function() {
        table.getRows().forEach(row => {
            const data = row.getData();
            row.update({
                total: (parseFloat(data.price) || 0) * (parseInt(data.quantity) || 0)
            });
        });
        table.recalc();
    });

    document.getElementById("add-row").addEventListener("click", function() {
        addRow(table.getData().length);
    });

    document.getElementById("save-btn").addEventListener("click", function() {
        const saveBtn = this;
        const statusContainer = document.getElementById('save-status');
        const originalBtnText = saveBtn.innerHTML;

        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...';
        saveBtn.disabled = true;
        statusContainer.innerHTML = '';

        const tableData = table.getData();
        const csrftoken = getCookie('csrftoken');

        fetch("{% url 'save_calculation_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                calculation_data: tableData,
                project_id: 123
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusContainer.innerHTML = `
                    <div class="alert alert-success mt-2">
                        Данные успешно сохранены! ID: ${data.calculation_id}
                    </div>
                `;
            } else {
                throw new Error(data.error || 'Неизвестная ошибка сервера');
            }
        })
        .catch(error => {
            statusContainer.innerHTML = `
                <div class="alert alert-danger mt-2">
                    Ошибка сохранения: ${error.message}
                </div>
            `;
        })
        .finally(() => {
            saveBtn.innerHTML = originalBtnText;
            saveBtn.disabled = false;
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

<style>
    .text-secondary { color: #6c757d; }
    .text-primary { color: #007bff; }
    .text-success { color: #28a745; }
    .text-info { color: #17a2b8; }
    .text-danger { color: #dc3545; }

    .d-flex {
        display: flex;
    }

    .flex-wrap {
        flex-wrap: wrap;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .table-controls-panel {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .table-controls-panel .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .align-items-center {
        align-items: center;
    }

    .ms-2 {
        margin-left: 0.5rem;
    }

    /* Стили для центрирования содержимого ячеек */
    .tabulator-cell {
        text-align: center;
        vertical-align: middle;
    }

    .tabulator-col {
        text-align: center;
    }



    /* Стиль для ячеек с номерами - курсор указатель */
    .tabulator-cell[tabulator-field="id"] {
        cursor: pointer;
    }
    .tabulator-cell[tabulator-field="id"]:hover {
        background-color: #f0f0f0;
    }

    /* Стили для контекстного меню */
    #rowContextMenu {
        display: none;
        z-index: 1000;
    }
</style>
{% endblock %}