{% extends 'base.html' %}
{% load static %}

{% block stats_dashboard %}
<!-- Пустой блок - скрываем статистику -->
{% endblock %}

{% block content %}
<div class="content-area">
    <!-- Main Card -->
    <div class="stats-section">
        <div class="table-container glass-effect">
            <!-- Action Buttons -->
            <div class="section-header mb-4">
                <h2 class="section-title">
                    <i class="bi bi-calculator"></i>
                    Управление расчетом
                </h2>
                <div class="section-badge">
                    <span class="badge total-amount">Всего строк: <span id="total-rows">0</span></span>
                </div>
            </div>

            <div class="d-flex flex-wrap gap-3 mb-4">
                <button id="calculate-btn" class="btn btn-primary">
                    <i class="bi bi-calculator-fill"></i>
                    Рассчитать
                </button>
                <button id="add-row" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i>
                    Добавить строку
                </button>
                <button id="save-btn" class="btn btn-info">
                    <i class="bi bi-save"></i>
                    Сохранить данные
                </button>
            </div>

            <!-- Table Controls Panel -->
            <div class="stats-filters glass-effect mb-4">
                <div class="filters-header">
                    <h3 class="filters-title">
                        <i class="bi bi-sliders"></i>
                        Управление столбцами
                    </h3>
                </div>
                <div class="filters-grid">
                    <!-- Row 1 -->
                    <div class="filter-group">
                        <button id="toggle-size-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-arrows-expand"></i>
                            <span class="btn-text">Размеры</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-transom-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-layout-three-columns"></i>
                            <span class="btn-text">Фрамуга</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-glazing1-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-grid-3x3"></i>
                            <span class="btn-text">Остекление 1</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-glazing2-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-grid-3x3"></i>
                            <span class="btn-text">Остекление 2</span>
                        </button>
                    </div>

                    <!-- Row 2 -->
                    <div class="filter-group">
                        <button id="toggle-metal-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-shield"></i>
                            <span class="btn-text">Металл</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-vent-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-grid"></i>
                            <span class="btn-text">Вентрешетка</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-bumper-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-border-all"></i>
                            <span class="btn-text">Отбойная пластина</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-extension-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-arrows-expand-vertical"></i>
                            <span class="btn-text">Добор</span>
                        </button>
                    </div>

                    <!-- Row 3 -->
                    <div class="filter-group">
                        <button id="toggle-color-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-palette"></i>
                            <span class="btn-text">Цвет</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-hardware1-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-gear"></i>
                            <span class="btn-text">Фурнитура 1</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-hardware2-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-gear"></i>
                            <span class="btn-text">Фурнитура 2</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-closer-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-arrow-left-right"></i>
                            <span class="btn-text">Доводчик</span>
                        </button>
                    </div>

                    <!-- Row 4 -->
                    <div class="filter-group">
                        <button id="toggle-cylinder-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-key"></i>
                            <span class="btn-text">Цилиндр</span>
                        </button>
                    </div>
                    <div class="filter-group">
                        <button id="toggle-autothreshold-btn" class="btn btn-outline-secondary btn-control">
                            <i class="bi bi-border-bottom"></i>
                            <span class="btn-text">Авт.порог</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="save-status" class="mt-3"></div>

            <!-- Calculation Table -->
            <div id="calculation-table" class="tabulator-container"></div>
        </div>
    </div>
</div>

<!-- Модальное окно для отображения информации о строке -->
<div class="modal fade" id="rowInfoModal" tabindex="-1" aria-labelledby="rowInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content glass-effect">
            <div class="modal-header">
                <h5 class="modal-title" id="rowInfoModalLabel">
                    <i class="bi bi-info-circle"></i>
                    Информация о строке #<span id="modal-row-id"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Поле</th>
                                <th>Значение</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Изделие</strong></td>
                                <td id="modal-product"></td>
                            </tr>
                            <tr>
                                <td><strong>Тип</strong></td>
                                <td id="modal-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Ширина</strong></td>
                                <td id="modal-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Высота</strong></td>
                                <td id="modal-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Фрамуга высота</strong></td>
                                <td id="modal-transom-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Фрамуга ширина</strong></td>
                                <td id="modal-transom-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Фрамуга остекление</strong></td>
                                <td id="modal-transom-glazing"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 1 вид</strong></td>
                                <td id="modal-glazing1-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 1 высота</strong></td>
                                <td id="modal-glazing1-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 1 ширина</strong></td>
                                <td id="modal-glazing1-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 2 вид</strong></td>
                                <td id="modal-glazing2-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 2 высота</strong></td>
                                <td id="modal-glazing2-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Остекление 2 ширина</strong></td>
                                <td id="modal-glazing2-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Металл</strong></td>
                                <td id="modal-metal"></td>
                            </tr>
                            <tr>
                                <td><strong>Вентрешетка вид</strong></td>
                                <td id="modal-vent-type"></td>
                            </tr>
                            <tr>
                                <td><strong>Вентрешетка высота</strong></td>
                                <td id="modal-vent-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Вентрешетка ширина</strong></td>
                                <td id="modal-vent-width"></td>
                            </tr>
                            <tr>
                                <td><strong>Отбойная пластина высота</strong></td>
                                <td id="modal-bumper-height"></td>
                            </tr>
                            <tr>
                                <td><strong>Отбойная пластина с 2-х сторон</strong></td>
                                <td id="modal-bumper-both-sides"></td>
                            </tr>
                            <tr>
                                <td><strong>Добор (толщина стены)</strong></td>
                                <td id="modal-extension"></td>
                            </tr>
                            <tr>
                                <td><strong>RALвнеш</strong></td>
                                <td id="modal-ral-external"></td>
                            </tr>
                            <tr>
                                <td><strong>RALвнутр</strong></td>
                                <td id="modal-ral-internal"></td>
                            </tr>
                            <tr>
                                <td><strong>муар</strong></td>
                                <td id="modal-moire"></td>
                            </tr>
                            <tr>
                                <td><strong>лак</strong></td>
                                <td id="modal-varnish"></td>
                            </tr>
                            <tr>
                                <td><strong>грунт</strong></td>
                                <td id="modal-primer"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 1 ручка</strong></td>
                                <td id="modal-hardware1-handle"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 1 замок</strong></td>
                                <td id="modal-hardware1-lock"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 2 ручка</strong></td>
                                <td id="modal-hardware2-handle"></td>
                            </tr>
                            <tr>
                                <td><strong>Фурнитура 2 замок</strong></td>
                                <td id="modal-hardware2-lock"></td>
                            </tr>
                            <tr>
                                <td><strong>Доводчик</strong></td>
                                <td id="modal-closer"></td>
                            </tr>
                            <tr>
                                <td><strong>Цилиндр</strong></td>
                                <td id="modal-cylinder"></td>
                            </tr>
                            <tr>
                                <td><strong>Авт.порог</strong></td>
                                <td id="modal-auto-threshold"></td>
                            </tr>
                            <tr>
                                <td><strong>Количество</strong></td>
                                <td id="modal-quantity"></td>
                            </tr>
                            <tr>
                                <td><strong>Сумма</strong></td>
                                <td id="modal-total"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    Закрыть
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Контекстное меню для строк -->
<div id="rowContextMenu" class="dropdown-menu glass-effect" style="display: none; position: fixed; z-index: 10000;">
    <button class="dropdown-item" type="button" data-action="add-above">
        <i class="bi bi-arrow-up"></i>
        Добавить строку сверху
    </button>
    <button class="dropdown-item" type="button" data-action="add-below">
        <i class="bi bi-arrow-down"></i>
        Добавить строку снизу
    </button>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item text-danger" type="button" data-action="delete">
        <i class="bi bi-trash"></i>
        Удалить строку
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Tabulator === 'undefined') {
        console.error('Tabulator не загружен!');
        document.getElementById('save-status').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Ошибка загрузки Tabulator. Пожалуйста, обновите страницу.
            </div>
        `;
        return;
    }

    // Данные для выпадающих списков (должны быть переданы из представления)
    const dropdownData = {{ dropdown_data|safe }};

    // Инициализация модального окна Bootstrap
    const rowInfoModal = new bootstrap.Modal(document.getElementById('rowInfoModal'));

    const customSelectEditor = function(cell, onRendered, success, cancel, editorParams) {
        const input = document.createElement("select");
        input.className = "form-select form-select-sm";

        for (const [value, label] of Object.entries(editorParams.values)) {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = label;
            if (value === cell.getValue()) option.selected = true;
            input.appendChild(option);
        }

        input.addEventListener("change", function() {
            success(input.value);
        });

        input.addEventListener("blur", function() {
            cancel();
        });

        onRendered(function() {
            input.focus();
        });

        return input;
    };

    const table = new Tabulator("#calculation-table", {
        data: [
            {
                id: 1,
                door_type: "door",
                price: 15000,
                quantity: 1,
                door_kind: "ei-60",
                width: 900,
                height: 2100,
                transom_height: 0,
                transom_width: 0,
                transom_glazing: "none",
                glazing1_type: "none",
                glazing1_height: 0,
                glazing1_width: 0,
                glazing2_type: "none",
                glazing2_height: 0,
                glazing2_width: 0,
                metal: "1.2-1.4",
                vent_type: "none",
                vent_height: 0,
                vent_width: 0,
                bumper_height: 0,
                bumper_both_sides: "no",
                extension: 0,
                ral_external: "9001",
                ral_internal: "9002",
                moire: "no",
                varnish: "yes",
                primer: "yes",
                hardware1_handle: "",
                hardware1_lock: "",
                hardware2_handle: "",
                hardware2_lock: "",
                closer: "",
                cylinder: "",
                auto_threshold: "no"
            },
            {
                id: 2,
                door_type: "door_2",
                price: 8000,
                quantity: 2,
                door_kind: "eis-60",
                width: 800,
                height: 2000,
                transom_height: 400,
                transom_width: 800,
                transom_glazing: "single",
                glazing1_type: "single",
                glazing1_height: 300,
                glazing1_width: 200,
                glazing2_type: "none",
                glazing2_height: 0,
                glazing2_width: 0,
                metal: "1.4-1.4",
                vent_type: "tech",
                vent_height: 100,
                vent_width: 200,
                bumper_height: 150,
                bumper_both_sides: "yes",
                extension: 120,
                ral_external: "9010",
                ral_internal: "9010",
                moire: "yes",
                varnish: "no",
                primer: "yes",
                hardware1_handle: "handle_type1",
                hardware1_lock: "lock_type1",
                hardware2_handle: "",
                hardware2_lock: "",
                closer: "closer_type1",
                cylinder: "cylinder_type1",
                auto_threshold: "yes"
            },
        ],
        columns: [
            {
                title: "№",
                field: "id",
                width: 60,
                frozen: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<span class="row-number">${value}</span>`;
                },
                cellClick: function(e, cell) {
                    showRowInfo(cell.getRow());
                }
            },
            {
                title: "Изделие",
                width: 120,
                field: "door_type",
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.door_types || {
                        "door": "Дверь",
                        "door_2": "Дверь 2-ств.",
                        "hatch": "Люк",
                        "gate": "Ворота"
                    }
                },
                formatter: function(cell) {
                    const map = dropdownData.door_types || {
                        "door": "Дверь",
                        "door_2": "Дверь 2-ств.",
                        "hatch": "Люк",
                        "gate": "Ворота"
                    };
                    const value = cell.getValue();
                    return `<span class="product-name">${map[value] || value}</span>`;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Тип",
                field: "door_kind",
                width: 80,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.door_kinds || {
                        "tech": "тех.",
                        "ei-60": "EI-60",
                        "eis-60": "EIS-60",
                        "revision": "однолист."
                    }
                },
                formatter: function(cell) {
                    const map = dropdownData.door_kinds || {
                        "tech": "тех.",
                        "ei-60": "EI-60",
                        "eis-60": "EIS-60",
                        "revision": "однолист."
                    };
                    const value = cell.getValue();
                    return `<span class="type-badge">${map[value] || value}</span>`;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Размеры по коробке",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Высота",
                        width: 90,
                        field: "height",
                        visible: true,
                        editor: "number",
                        validator: ["required", "numeric", "min:100", "max:3000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "width",
                        visible: true,
                        editor: "number",
                        validator: ["required", "numeric", "min:100", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                ]
            },
            {
                title: "Фрамуга",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Высота",
                        width: 90,
                        field: "transom_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:1000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "transom_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Вид остекления",
                        width: 110,
                        field: "transom_glazing",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            };
                            const value = cell.getValue();
                            return `<span class="glazing-type">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Остекление_1",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Вид",
                        width: 100,
                        field: "glazing1_type",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            };
                            const value = cell.getValue();
                            return `<span class="glazing-type">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "Высота",
                        width: 90,
                        field: "glazing1_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:1000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "glazing1_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    }
                ]
            },
            {
                title: "Остекление_2",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Вид",
                        width: 100,
                        field: "glazing2_type",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.glazing_types || {
                                "none": "нет",
                                "single": "однокамерное",
                                "double": "двухкамерное",
                                "triple": "трехкамерное",
                                "laminated": "триплекс"
                            };
                            const value = cell.getValue();
                            return `<span class="glazing-type">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "Высота",
                        width: 90,
                        field: "glazing2_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:1000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "glazing2_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:2000"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    }
                ]
            },
            {
                title: "Металл",
                width: 100,
                field: "metal",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.metal_types || {
                        "1.2-1.4": "1.2-1.4",
                        "1.4-1.4": "1.4-1.4",
                        "1.4-2.0": "1.4-2.0"
                    }
                },
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<span class="metal-type">${value}</span>`;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Вентрешетка",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Вид",
                        width: 80,
                        field: "vent_type",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.vent_types || {
                                "none": "нет",
                                "tech": "тех.",
                                "semi-prof": "п/п"
                            }
                        },
                        formatter: function(cell) {
                            const map = dropdownData.vent_types || {
                                "none": "нет",
                                "tech": "тех.",
                                "semi-prof": "п/п"
                            };
                            const value = cell.getValue();
                            return `<span class="vent-type">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "Высота",
                        width: 90,
                        field: "vent_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:500"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "Ширина",
                        width: 95,
                        field: "vent_width",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:500"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    }
                ]
            },
            {
                title: "Отбойная пластина",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "Высота",
                        width: 90,
                        field: "bumper_height",
                        visible: false,
                        editor: "number",
                        validator: ["numeric", "min:0", "max:300"],
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                        },
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false
                    },
                    {
                        title: "С 2-х сторон",
                        width: 110,
                        field: "bumper_both_sides",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "no": "нет",
                                "yes": "да"
                            }
                        },
                        formatter: function(cell) {
                            const map = {
                                "no": "нет",
                                "yes": "да"
                            };
                            const value = cell.getValue();
                            return `<span class="boolean-value ${value === 'yes' ? 'text-success' : 'text-secondary'}">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Добор",
                width: 100,
                field: "extension",
                visible: false,
                editor: "number",
                validator: ["numeric", "min:0", "max:500"],
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? `<span class="dimension-value">${value} мм</span>` : "—";
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Цвет",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "RAL внеш",
                        width: 80,
                        field: "ral_external",
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.ral_colors || {}
                        },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="color-value">${value}</span>` : "—";
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "RAL внутр",
                        width: 80,
                        field: "ral_internal",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.ral_colors || {}
                        },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="color-value">${value}</span>` : "—";
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "муар",
                        width: 60,
                        field: "moire",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "yes": "да",
                                "no": "нет"
                            }
                        },
                        formatter: function(cell) {
                            const map = {"yes": "да", "no": "нет"};
                            const value = cell.getValue();
                            return `<span class="boolean-value ${value === 'yes' ? 'text-success' : 'text-secondary'}">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "лак",
                        width: 60,
                        field: "varnish",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "yes": "да",
                                "no": "нет"
                            }
                        },
                        formatter: function(cell) {
                            const map = {"yes": "да", "no": "нет"};
                            const value = cell.getValue();
                            return `<span class="boolean-value ${value === 'yes' ? 'text-success' : 'text-secondary'}">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "грунт",
                        width: 60,
                        field: "primer",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: {
                                "yes": "да",
                                "no": "нет"
                            }
                        },
                        formatter: function(cell) {
                            const map = {"yes": "да", "no": "нет"};
                            const value = cell.getValue();
                            return `<span class="boolean-value ${value === 'yes' ? 'text-success' : 'text-secondary'}">${map[value] || value}</span>`;
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Фурнитура_1",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "ручка",
                        width: 100,
                        field: "hardware1_handle",
                        visible: true,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_handles || {}
                        },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="hardware-item">${value}</span>` : "—";
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "замок",
                        width: 100,
                        field: "hardware1_lock",
                        visible: true,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_locks || {}
                        },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="hardware-item">${value}</span>` : "—";
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Фурнитура_2",
                headerHozAlign: "center",
                columns: [
                    {
                        title: "ручка",
                        width: 100,
                        field: "hardware2_handle",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_handles || {}
                        },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="hardware-item">${value}</span>` : "—";
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    },
                    {
                        title: "замок",
                        width: 100,
                        field: "hardware2_lock",
                        visible: false,
                        editor: customSelectEditor,
                        editorParams: {
                            values: dropdownData.hardware_locks || {}
                        },
                        formatter: function(cell) {
                            const value = cell.getValue();
                            return value ? `<span class="hardware-item">${value}</span>` : "—";
                        },
                        editable: true,
                        hozAlign: "center",
                        vertAlign: "middle",
                        headerHozAlign: "center",
                        headerSort: false,
                        cellClick: function(e, cell) {
                            cell.edit();
                        }
                    }
                ]
            },
            {
                title: "Доводчик",
                width: 100,
                field: "closer",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.closers || {}
                },
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? `<span class="hardware-item">${value}</span>` : "—";
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Цилиндр",
                width: 100,
                field: "cylinder",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: dropdownData.cylinders || {}
                },
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? `<span class="hardware-item">${value}</span>` : "—";
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Авт.порог",
                width: 90,
                field: "auto_threshold",
                visible: false,
                editor: customSelectEditor,
                editorParams: {
                    values: {
                        "yes": "да",
                        "no": "нет"
                    }
                },
                formatter: function(cell) {
                    const map = {"yes": "да", "no": "нет"};
                    const value = cell.getValue();
                    return `<span class="boolean-value ${value === 'yes' ? 'text-success' : 'text-secondary'}">${map[value] || value}</span>`;
                },
                editable: true,
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                headerSort: false,
                cellClick: function(e, cell) {
                    cell.edit();
                }
            },
            {
                title: "Кол-во",
                field: "quantity",
                width: 80,
                editor: "number",
                validator: ["required", "integer", "min:1"],
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return `<span class="quantity-badge">${value} шт</span>`;
                }
            },
            {
                title: "Сумма (₽)",
                field: "total",
                width: 120,
                formatter: function(cell) {
                    const value = cell.getValue() || 0;
                    return `<span class="amount-value">${value.toLocaleString('ru-RU')} ₽</span>`;
                },
                bottomCalcParams: {precision: 0},
                mutator: function(value, data) {
                    const price = parseFloat(data.price) || 0;
                    const quantity = parseInt(data.quantity) || 0;
                    return price * quantity;
                },
                hozAlign: "center",
                vertAlign: "middle",
                headerHozAlign: "center"
            }

        ],

        layout: "fitColumns",

        height: "100%", // Занимает всю доступную высоту контейнера
        maxHeight: "80vh", // Ограничиваем максимальную высоту
        renderVertical: "virtual", // Виртуализация для производительности
        rowContext: function(e, row) {
            e.preventDefault();
            showContextMenu(e, row);
        },
        dataChanged: function(data) {
            document.getElementById('total-rows').textContent = data.length;
            // Автоматически подстраиваем высоту таблицы
            setTimeout(() => {
                adjustTableHeight();
            }, 10);
        },
        rowAdded: function(row) {
            // Подстраиваем высоту при добавлении строки
            setTimeout(() => {
                adjustTableHeight();
            }, 10);
        },
        rowDeleted: function(row) {
            // Подстраиваем высоту при удалении строки
            setTimeout(() => {
                adjustTableHeight();
            }, 10);
        },
        cellEdited: function(cell) {
            const fieldsToRecalc = ["price", "quantity", "width", "height", "transom_height", "transom_width",
                                  "glazing1_height", "glazing1_width", "glazing2_height", "glazing2_width",
                                  "vent_height", "vent_width", "bumper_height", "extension"];
            if (fieldsToRecalc.includes(cell.getField())) {
                const row = cell.getRow();
                row.recalc();
            }
        }
    });
    // Функция для автоматической подстройки высоты таблицы
        function adjustTableHeight() {
            const tableElement = document.getElementById('calculation-table');
            const tableContainer = tableElement.closest('.table-container');

            if (!tableElement || !tableContainer) return;

            // Получаем все строки таблицы
            const rows = table.getRows();
            const headerHeight = 50; // Примерная высота заголовка
            const rowHeight = 48; // Примерная высота одной строки
            const padding = 20; // Отступы

            if (rows.length === 0) {
                // Минимальная высота когда нет строк
                tableElement.style.height = '200px';
                return;
            }

            // Рассчитываем общую высоту
            let totalHeight = headerHeight + (rows.length * rowHeight) + padding;

            // Ограничиваем максимальную высоту
            const maxHeight = window.innerHeight * 0.8; // 80% от высоты окна
            totalHeight = Math.min(totalHeight, maxHeight);

            // Устанавливаем минимальную высоту
            totalHeight = Math.max(totalHeight, 200);

            // Применяем высоту
            tableElement.style.height = totalHeight + 'px';

            // Перерисовываем таблицу
            table.redraw(true);
        }

        // Обработчик изменения размера окна
        window.addEventListener('resize', function() {
            adjustTableHeight();
        });

        // Вызываем при загрузке
        setTimeout(() => {
            adjustTableHeight();
        }, 100);

    // Обновляем счетчик строк при загрузке
    document.getElementById('total-rows').textContent = table.getDataCount();

    // Обработчик контекстного меню для строк
    let contextMenuRow = null;

    function showContextMenu(e, row) {
        e.preventDefault();
        contextMenuRow = row;

        // Позиционируем контекстное меню
        const menu = document.getElementById("rowContextMenu");
        menu.style.display = "block";
        menu.style.left = e.pageX + "px";
        menu.style.top = e.pageY + "px";
    }

    // Закрытие контекстного меню при клике вне его
    document.addEventListener("click", function(e) {
        const menu = document.getElementById("rowContextMenu");
        if (menu.style.display === "block" && !menu.contains(e.target)) {
            menu.style.display = "none";
        }
    });

    // Обработка действий контекстного меню
    document.querySelectorAll("#rowContextMenu .dropdown-item").forEach(item => {
        item.addEventListener("click", function() {
            const action = this.getAttribute("data-action");
            const menu = document.getElementById("rowContextMenu");
            menu.style.display = "none";

            if (!contextMenuRow) return;

            const rowData = contextMenuRow.getData();
            const rowIndex = table.getRows().indexOf(contextMenuRow);

            switch(action) {
                case "add-above":
                    addRow(rowIndex);
                    break;
                case "add-below":
                    addRow(rowIndex + 1);
                    break;
                case "delete":
                    contextMenuRow.delete();
                    setTimeout(() => {
                    adjustTableHeight();
                    }, 50);
                    break;
            }

            contextMenuRow = null;
        });
    });

    // Функция добавления строки
    function addRow(index) {
        const newId = table.getData().length + 1;
        const newRow = {
            id: newId,
            door_type: "door",
            price: 0,
            quantity: 1,
            door_kind: "tech",
            width: 800,
            height: 2000,
            transom_height: 0,
            transom_width: 0,
            transom_glazing: "none",
            glazing1_type: "none",
            glazing1_height: 0,
            glazing1_width: 0,
            glazing2_type: "none",
            glazing2_height: 0,
            glazing2_width: 0,
            metal: "1.2-1.4",
            vent_type: "none",
            vent_height: 0,
            vent_width: 0,
            bumper_height: 0,
            bumper_both_sides: "no",
            extension: 0,
            ral_external: "",
            ral_internal: "",
            moire: "no",
            varnish: "no",
            primer: "no",
            hardware1_handle: "",
            hardware1_lock: "",
            hardware2_handle: "",
            hardware2_lock: "",
            closer: "",
            cylinder: "",
            auto_threshold: "no"
        };

        table.addRow(newRow, false, index);
            // Автоматически подстраиваем высоту после добавления строки
        setTimeout(() => {
        adjustTableHeight();
        }, 50)
    }

    // Функция для отображения информации о строке в модальном окне
    function showRowInfo(row) {
        const data = row.getData();

        // Заполняем модальное окно данными
        document.getElementById('modal-row-id').textContent = data.id;
        document.getElementById('modal-product').textContent = data.door_type ?
            ((dropdownData.door_types || {})[data.door_type] || data.door_type) : "—";

        document.getElementById('modal-type').textContent = data.door_kind ?
            ((dropdownData.door_kinds || {})[data.door_kind] || data.door_kind) : "—";

        document.getElementById('modal-width').textContent = data.width ? data.width + " мм" : "—";
        document.getElementById('modal-height').textContent = data.height ? data.height + " мм" : "—";
        document.getElementById('modal-transom-height').textContent = data.transom_height ? data.transom_height + " мм" : "—";
        document.getElementById('modal-transom-width').textContent = data.transom_width ? data.transom_width + " мм" : "—";

        document.getElementById('modal-transom-glazing').textContent = data.transom_glazing ?
            ((dropdownData.glazing_types || {})[data.transom_glazing] || data.transom_glazing) : "—";

        document.getElementById('modal-glazing1-type').textContent = data.glazing1_type ?
            ((dropdownData.glazing_types || {})[data.glazing1_type] || data.glazing1_type) : "—";
        document.getElementById('modal-glazing1-height').textContent = data.glazing1_height ? data.glazing1_height + " мм" : "—";
        document.getElementById('modal-glazing1-width').textContent = data.glazing1_width ? data.glazing1_width + " мм" : "—";

        document.getElementById('modal-glazing2-type').textContent = data.glazing2_type ?
            ((dropdownData.glazing_types || {})[data.glazing2_type] || data.glazing2_type) : "—";
        document.getElementById('modal-glazing2-height').textContent = data.glazing2_height ? data.glazing2_height + " мм" : "—";
        document.getElementById('modal-glazing2-width').textContent = data.glazing2_width ? data.glazing2_width + " мм" : "—";

        document.getElementById('modal-metal').textContent = data.metal ?
            ((dropdownData.metal_types || {})[data.metal] || data.metal) : "—";

        document.getElementById('modal-vent-type').textContent = data.vent_type ?
            ((dropdownData.vent_types || {})[data.vent_type] || data.vent_type) : "—";
        document.getElementById('modal-vent-height').textContent = data.vent_height ? data.vent_height + " мм" : "—";
        document.getElementById('modal-vent-width').textContent = data.vent_width ? data.vent_width + " мм" : "—";

        document.getElementById('modal-bumper-height').textContent = data.bumper_height ? data.bumper_height + " мм" : "—";
        document.getElementById('modal-bumper-both-sides').textContent = data.bumper_both_sides ?
            ({"no": "нет", "yes": "да"}[data.bumper_both_sides] || data.bumper_both_sides) : "—";

        document.getElementById('modal-extension').textContent = data.extension ? data.extension + " мм" : "—";

        document.getElementById('modal-ral-external').textContent = data.ral_external ?
            ((dropdownData.ral_colors || {})[data.ral_external] || data.ral_external) : "—";
        document.getElementById('modal-ral-internal').textContent = data.ral_internal ?
            ((dropdownData.ral_colors || {})[data.ral_internal] || data.ral_internal) : "—";
        document.getElementById('modal-moire').textContent = data.moire ?
            ({"yes": "да", "no": "нет"}[data.moire] || data.moire) : "—";
        document.getElementById('modal-varnish').textContent = data.varnish ?
            ({"yes": "да", "no": "нет"}[data.varnish] || data.varnish) : "—";
        document.getElementById('modal-primer').textContent = data.primer ?
            ({"yes": "да", "no": "нет"}[data.primer] || data.primer) : "—";

        document.getElementById('modal-hardware1-handle').textContent = data.hardware1_handle ?
            ((dropdownData.hardware_handles || {})[data.hardware1_handle] || data.hardware1_handle) : "—";
        document.getElementById('modal-hardware1-lock').textContent = data.hardware1_lock ?
            ((dropdownData.hardware_locks || {})[data.hardware1_lock] || data.hardware1_lock) : "—";
        document.getElementById('modal-hardware2-handle').textContent = data.hardware2_handle ?
            ((dropdownData.hardware_handles || {})[data.hardware2_handle] || data.hardware2_handle) : "—";
        document.getElementById('modal-hardware2-lock').textContent = data.hardware2_lock ?
            ((dropdownData.hardware_locks || {})[data.hardware2_lock] || data.hardware2_lock) : "—";
        document.getElementById('modal-closer').textContent = data.closer ?
            ((dropdownData.closers || {})[data.closer] || data.closer) : "—";
        document.getElementById('modal-cylinder').textContent = data.cylinder ?
            ((dropdownData.cylinders || {})[data.cylinder] || data.cylinder) : "—";
        document.getElementById('modal-auto-threshold').textContent = data.auto_threshold ?
            ({"yes": "да", "no": "нет"}[data.auto_threshold] || data.auto_threshold) : "—";

        document.getElementById('modal-quantity').textContent = data.quantity || "—";

        // Рассчитываем сумму
        const total = (parseFloat(data.price) || 0) * (parseInt(data.quantity) || 0);
        document.getElementById('modal-total').textContent = total.toLocaleString('ru-RU') + " ₽";

        // Показываем модальное окно
        rowInfoModal.show();
    }

    // Функция для переключения видимости группы столбцов
    function toggleColumnGroup(buttonId, columnFields) {
        document.getElementById(buttonId).addEventListener("click", function() {
            const button = this;
            const columns = columnFields.map(field => table.getColumn(field)).filter(col => col);

            if (columns.length === 0) return;

            const isVisible = columns[0].isVisible();
            const newVisible = !isVisible;

            // Переключаем видимость всех столбцов в группе
            columns.forEach(column => {
                column.toggle(newVisible);
            });

            // Обновляем текст и стиль кнопки
            const btnText = button.querySelector('.btn-text');
            if (newVisible) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-secondary');
                btnText.textContent = btnText.textContent.replace('Показать', 'Скрыть');
            } else {
                button.classList.remove('btn-secondary');
                button.classList.add('btn-outline-secondary');
                btnText.textContent = btnText.textContent.replace('Скрыть', 'Показать');
            }

            table.redraw(true);
        });
    }

    // Инициализация обработчиков для всех кнопок переключения столбцов
    toggleColumnGroup("toggle-size-btn", ["width", "height"]);
    toggleColumnGroup("toggle-transom-btn", ["transom_height", "transom_width", "transom_glazing"]);
    toggleColumnGroup("toggle-glazing1-btn", ["glazing1_type", "glazing1_height", "glazing1_width"]);
    toggleColumnGroup("toggle-glazing2-btn", ["glazing2_type", "glazing2_height", "glazing2_width"]);
    toggleColumnGroup("toggle-metal-btn", ["metal"]);
    toggleColumnGroup("toggle-vent-btn", ["vent_type", "vent_height", "vent_width"]);
    toggleColumnGroup("toggle-bumper-btn", ["bumper_height", "bumper_both_sides"]);
    toggleColumnGroup("toggle-extension-btn", ["extension"]);
    toggleColumnGroup("toggle-color-btn", ["ral_internal", "moire", "varnish", "primer"]); // ral_external всегда видим
    toggleColumnGroup("toggle-hardware1-btn", ["hardware1_handle", "hardware1_lock"]);
    toggleColumnGroup("toggle-hardware2-btn", ["hardware2_handle", "hardware2_lock"]);
    toggleColumnGroup("toggle-closer-btn", ["closer"]);
    toggleColumnGroup("toggle-cylinder-btn", ["cylinder"]);
    toggleColumnGroup("toggle-autothreshold-btn", ["auto_threshold"]);

    // Функция расчета
    document.getElementById("calculate-btn").addEventListener("click", function() {
        const calculateBtn = this;
        const originalText = calculateBtn.innerHTML;

        calculateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Расчет...';
        calculateBtn.disabled = true;

        // Имитация расчета
        setTimeout(() => {
            table.getRows().forEach(row => {
                const data = row.getData();
                // Здесь должна быть ваша логика расчета
                const calculatedTotal = (parseFloat(data.price) || 0) * (parseInt(data.quantity) || 0);
                row.update({
                    total: calculatedTotal
                });
            });
            table.recalc();

            calculateBtn.innerHTML = '<i class="bi bi-check-lg"></i> Рассчитано';
            calculateBtn.classList.remove('btn-primary');
            calculateBtn.classList.add('btn-success');

            setTimeout(() => {
                calculateBtn.innerHTML = originalText;
                calculateBtn.classList.remove('btn-success');
                calculateBtn.classList.add('btn-primary');
                calculateBtn.disabled = false;
            }, 2000);
        }, 500);
    });

    document.getElementById("add-row").addEventListener("click", function() {
        addRow(table.getData().length);
    });

    document.getElementById("save-btn").addEventListener("click", function() {
        const saveBtn = this;
        const statusContainer = document.getElementById('save-status');
        const originalBtnText = saveBtn.innerHTML;

        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Сохранение...';
        saveBtn.disabled = true;
        statusContainer.innerHTML = '';

        const tableData = table.getData();
        const csrftoken = getCookie('csrftoken');

        // ЗАМЕНИТЕ URL НА АКТУАЛЬНЫЙ ДЛЯ ВАШЕГО ПРОЕКТА
        fetch("{% url 'save_calculation_data' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                calculation_data: tableData,
                project_id: 123  // Замените на актуальный ID проекта
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusContainer.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        Данные успешно сохранены! ID: ${data.calculation_id}
                    </div>
                `;
            } else {
                throw new Error(data.error || 'Неизвестная ошибка сервера');
            }
        })
        .catch(error => {
            statusContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Ошибка сохранения: ${error.message}
                </div>
            `;
        })
        .finally(() => {
            saveBtn.innerHTML = originalBtnText;
            saveBtn.disabled = false;

            // Автоскрытие уведомления через 5 секунд
            setTimeout(() => {
                statusContainer.innerHTML = '';
            }, 5000);
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

<style>
/* Кастомные стили для калькулятора */
.tabulator-container {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-height: 200px; /* Минимальная высота */
    transition: height 0.3s ease;
}

.tabulator-table {
    background: transparent;
    height: auto !important;
}
.tabulator-row:last-child {
    border-bottom: none;
}
.tabulator-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    border: none;
}

.tabulator-col {
    border-right: 1px solid rgba(255, 255, 255, 0.2);
    background: transparent !important;
}

.tabulator-col .tabulator-col-content {
    padding: 0.75rem 0.5rem;
}

.tabulator-row {
    transition: var(--transition-smooth);
    border-bottom: 1px solid #e2e8f0;
    background: transparent;
}

.tabulator-row:hover {
    background: rgba(102, 126, 234, 0.05) !important;
    transform: translateX(2px);
}

.tabulator-cell {
    padding: 0.75rem 0.5rem;
    border-right: 1px solid #e2e8f0;
    background: transparent;
}

.tabulator-cell:first-child {
    border-left: none;
}

.tabulator-cell:last-child {
    border-right: none;
}
.tabulator-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 150px;
    color: #a0aec0;
    font-size: 1.1rem;
    font-weight: 500;
}

.tabulator-placeholder span {
    padding: 2rem;
    text-align: center;
}

/* Адаптивные стили */
@media (max-width: 768px) {
    .tabulator-container {
        min-height: 150px;
    }

    #calculation-table {
        min-height: 150px;
    }
}
/* Стили для ячеек */
.row-number {
    font-weight: 600;
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.875rem;
}

.product-name {
    font-weight: 500;
    color: #2d3748;
}

.type-badge {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
}

.dimension-value {
    font-weight: 600;
    color: #4a5568;
    font-size: 0.875rem;
}

.glazing-type {
    font-weight: 500;
    color: #2d3748;
    font-size: 0.85rem;
}

.metal-type {
    font-weight: 600;
    color: #2d3748;
}

.vent-type {
    font-weight: 500;
    color: #4a5568;
    font-size: 0.85rem;
}

.boolean-value {
    font-weight: 500;
    font-size: 0.85rem;
}

.color-value {
    font-weight: 600;
    color: #2d3748;
    background: rgba(255, 255, 255, 0.5);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
}

.hardware-item {
    font-weight: 500;
    color: #4a5568;
    font-size: 0.85rem;
}

.quantity-badge {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.875rem;
}

.amount-value {
    font-weight: 700;
    color: #2d3748;
    font-size: 0.9rem;
    background: rgba(102, 126, 234, 0.05);
    padding: 0.3rem 0.6rem;
    border-radius: 8px;
}

/* Кнопки управления */
.btn-control {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    transition: var(--transition-smooth);
    border: 2px solid #e2e8f0;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-control:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
}

.btn-control.btn-secondary {
    background: rgba(102, 126, 234, 0.1);
    border-color: #667eea;
    color: #667eea;
}

/* Сетка фильтров */
.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

/* Контекстное меню */
#rowContextMenu {
    box-shadow: var(--shadow-large);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 0.5rem;
}

#rowContextMenu .dropdown-item {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    transition: var(--transition-smooth);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#rowContextMenu .dropdown-item:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateX(3px);
}

/* Адаптивность */
@media (max-width: 768px) {
    .filters-grid {
        grid-template-columns: 1fr;
    }

    .tabulator-container {
        font-size: 0.875rem;
    }

    .tabulator-col {
        min-width: 80px;
    }

    .section-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }

    .d-flex.flex-wrap {
        justify-content: center;
    }

    .btn {
        flex: 1;
        min-width: 140px;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .content-area {
        padding: 0 1rem 1rem;
    }

    .stats-header {
        text-align: center;
    }

    .tabulator-container {
        font-size: 0.8rem;
    }
}

/* Анимации */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert {
    animation: fadeIn 0.3s ease-out;
    border: none;
    border-radius: 12px;
    padding: 1rem 1.5rem;
}

/* Стили для выпадающих списков в таблице */
.tabulator-select-editor {
    border: 2px solid #667eea;
    border-radius: 6px;
    padding: 0.25rem;
    background: white;
    font-size: 0.875rem;
}

/* Подсветка редактируемых ячеек */
.tabulator-cell.editing {
    background: rgba(102, 126, 234, 0.1) !important;
}

</style>
{% endblock %}